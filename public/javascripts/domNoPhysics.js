//code snippets borrowed from 
//https://github.com/IceCreamYou/Nemesis/blob/angelhack/main.js
//http://chandlerprall.github.com/Physijs/ the collisions.html example page

// since this is supposed to be a self-contained bookmarkelet, including jquery is a little trickier than usual.

(function(){
	var player, camera;
	var players = {};
  var id;
  var connected;
  var base="http://domserver.herokuapp.com/public/javascripts/";
  var socketsrc="http://domserver.herokuapp.com/socket.io/socket.io.js";
	var prevPosition;
	var frameCount = 0;

  function include(url, callback) { 
    if(url instanceof Array) {
      if(url.length == 0) {
        callback();
        return;
      }
      include(url[0], function() {
        include(url.slice(1), callback);
      });
      return;
    }
    var done = false;
    var script = document.createElement("script");
    script.src = url;
    script.onload = script.onreadystatechange = function(){
      if (!done && (!this.readyState || this.readyState == "loaded" || this.readyState == "complete")) {
        done = true;
        callback();
      }
    };
    document.getElementsByTagName("head")[0].appendChild(script);
  }

  include([base+'jquery-1.8.2.min.js',base+'three.min.js',base+'html2canvas.js', base+'physi.js', base+'stats.js', socketsrc], function() {
		Physijs.scripts.worker = "data:text/plain;charset=utf-8;base64,J3VzZSBzdHJpY3QnOw0KDQp2YXIJDQoJdHJhbnNmZXJhYmxlTWVzc2FnZSA9IHNlbGYud2Via2l0UG9zdE1lc3NhZ2UgfHwgc2VsZi5wb3N0TWVzc2FnZSwNCgkNCgkvLyBlbnVtDQoJTUVTU0FHRV9UWVBFUyA9IHsNCgkJV09STERSRVBPUlQ6IDAsDQoJCUNPTExJU0lPTlJFUE9SVDogMSwNCgkJVkVISUNMRVJFUE9SVDogMiwNCgkJQ09OU1RSQUlOVFJFUE9SVDogMw0KCX0sDQoJDQoJLy8gdGVtcCB2YXJpYWJsZXMNCglfb2JqZWN0LA0KCV92ZWN0b3IsDQoJX3RyYW5zZm9ybSwNCgkNCgkvLyBmdW5jdGlvbnMNCglwdWJsaWNfZnVuY3Rpb25zID0ge30sDQoJZ2V0U2hhcGVGcm9tQ2FjaGUsDQoJc2V0U2hhcGVDYWNoZSwNCgljcmVhdGVTaGFwZSwNCglyZXBvcnRXb3JsZCwNCglyZXBvcnRWZWhpY2xlcywNCglyZXBvcnRDb2xsaXNpb25zLA0KCXJlcG9ydENvbnN0cmFpbnRzLA0KCQ0KCS8vIHdvcmxkIHZhcmlhYmxlcw0KCWZpeGVkVGltZVN0ZXAsIC8vIHVzZWQgd2hlbiBjYWxsaW5nIHN0ZXBTaW11bGF0aW9uDQoJcmF0ZUxpbWl0LCAvLyBzZXRzIHdoZXRoZXIgb3Igbm90IHRvIHN5bmMgdGhlIHNpbXVsYXRpb24gcmF0ZSB3aXRoIGZpeGVkVGltZVN0ZXANCglsYXN0X3NpbXVsYXRpb25fdGltZSwNCglsYXN0X3NpbXVsYXRpb25fZHVyYXRpb24gPSAwLA0KCXdvcmxkLA0KCQ0KCS8vIHByaXZhdGUgY2FjaGUNCglfb2JqZWN0cyA9IHt9LA0KCV92ZWhpY2xlcyA9IHt9LA0KCV9jb25zdHJhaW50cyA9IHt9LA0KCV9tYXRlcmlhbHMgPSB7fSwNCglfb2JqZWN0c19hbW1vID0ge30sDQoJX251bV9vYmplY3RzID0gMCwNCglfbnVtX3doZWVscyA9IDAsDQoJX251bV9jb25zdHJhaW50cyA9IDAsDQoJX29iamVjdF9zaGFwZXMgPSB7fSwNCgkNCgkvLyBvYmplY3QgcmVwb3J0aW5nDQoJUkVQT1JUX0NIVU5LU0laRSwgLy8gcmVwb3J0IGFycmF5IGlzIGluY3JlYXNlZCBpbiBpbmNyZW1lbnRzIG9mIHRoaXMgY2h1bmsgc2l6ZQ0KCQ0KCVdPUkxEUkVQT1JUX0lURU1TSVpFID0gMTQsIC8vIGhvdyBtYW55IGZsb2F0IHZhbHVlcyBlYWNoIHJlcG9ydGVkIGl0ZW0gbmVlZHMNCgl3b3JsZHJlcG9ydCwNCg0KCUNPTExJU0lPTlJFUE9SVF9JVEVNU0laRSA9IDIsIC8vIG9uZSBmbG9hdCBmb3IgZWFjaCBvYmplY3QgaWQNCgljb2xsaXNpb25yZXBvcnQsDQoNCglWRUhJQ0xFUkVQT1JUX0lURU1TSVpFID0gOSwgLy8gdmVoaWNsZSBpZCwgd2hlZWwgaW5kZXgsIDMgZm9yIHBvc2l0aW9uLCA0IGZvciByb3RhdGlvbg0KCXZlaGljbGVyZXBvcnQsDQoNCglDT05TVFJBSU5UUkVQT1JUX0lURU1TSVpFID0gNiwgLy8gY29uc3RyYWludCBpZCwgb2Zmc2V0IG9iamVjdCwgb2Zmc2V0LCBhcHBsaWVkIGltcHVsc2UNCgljb25zdHJhaW50cmVwb3J0Ow0KDQoNCmdldFNoYXBlRnJvbUNhY2hlID0gZnVuY3Rpb24gKCBjYWNoZV9rZXkgKSB7DQoJaWYgKCBfb2JqZWN0X3NoYXBlc1sgY2FjaGVfa2V5IF0gIT09IHVuZGVmaW5lZCApIHsNCgkJcmV0dXJuIF9vYmplY3Rfc2hhcGVzWyBjYWNoZV9rZXkgXTsNCgl9DQoJcmV0dXJuIG51bGw7DQp9Ow0KDQpzZXRTaGFwZUNhY2hlID0gZnVuY3Rpb24gKCBjYWNoZV9rZXksIHNoYXBlICkgew0KCV9vYmplY3Rfc2hhcGVzWyBjYWNoZV9rZXkgXSA9IHNoYXBlOw0KfQ0KDQpjcmVhdGVTaGFwZSA9IGZ1bmN0aW9uKCBkZXNjcmlwdGlvbiApIHsNCgl2YXIgY2FjaGVfa2V5LCBzaGFwZTsNCgkNCglfdHJhbnNmb3JtLnNldElkZW50aXR5KCk7DQoJDQoJc3dpdGNoICggZGVzY3JpcHRpb24udHlwZSApIHsNCgkJY2FzZSAncGxhbmUnOg0KCQkJY2FjaGVfa2V5ID0gJ3BsYW5lXycgKyBkZXNjcmlwdGlvbi5ub3JtYWwueCArICdfJyArIGRlc2NyaXB0aW9uLm5vcm1hbC55ICsgJ18nICsgZGVzY3JpcHRpb24ubm9ybWFsLno7DQoJCQlpZiAoICggc2hhcGUgPSBnZXRTaGFwZUZyb21DYWNoZSggY2FjaGVfa2V5ICkgKSA9PT0gbnVsbCApIHsNCgkJCQlzaGFwZSA9IG5ldyBBbW1vLmJ0U3RhdGljUGxhbmVTaGFwZSggbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXNjcmlwdGlvbi5ub3JtYWwueCwgZGVzY3JpcHRpb24ubm9ybWFsLnksIGRlc2NyaXB0aW9uLm5vcm1hbC56ICksIDAgKTsNCgkJCQlzZXRTaGFwZUNhY2hlKCBjYWNoZV9rZXksIHNoYXBlICk7DQoJCQl9DQoJCQlicmVhazsNCgkJDQoJCWNhc2UgJ2JveCc6DQoJCQljYWNoZV9rZXkgPSAnYm94XycgKyBkZXNjcmlwdGlvbi53aWR0aCArICdfJyArIGRlc2NyaXB0aW9uLmhlaWdodCArICdfJyArIGRlc2NyaXB0aW9uLmRlcHRoOw0KCQkJaWYgKCAoIHNoYXBlID0gZ2V0U2hhcGVGcm9tQ2FjaGUoIGNhY2hlX2tleSApICkgPT09IG51bGwgKSB7DQoJCQkJc2hhcGUgPSBuZXcgQW1tby5idEJveFNoYXBlKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGVzY3JpcHRpb24ud2lkdGggLyAyLCBkZXNjcmlwdGlvbi5oZWlnaHQgLyAyLCBkZXNjcmlwdGlvbi5kZXB0aCAvIDIgKSk7DQoJCQkJc2V0U2hhcGVDYWNoZSggY2FjaGVfa2V5LCBzaGFwZSApOw0KCQkJfQ0KCQkJYnJlYWs7DQoJCQ0KCQljYXNlICdzcGhlcmUnOg0KCQkJY2FjaGVfa2V5ID0gJ3NwaGVyZV8nICsgZGVzY3JpcHRpb24ucmFkaXVzOw0KCQkJaWYgKCAoIHNoYXBlID0gZ2V0U2hhcGVGcm9tQ2FjaGUoIGNhY2hlX2tleSApICkgPT09IG51bGwgKSB7DQoJCQkJc2hhcGUgPSBuZXcgQW1tby5idFNwaGVyZVNoYXBlKCBkZXNjcmlwdGlvbi5yYWRpdXMgKTsNCgkJCQlzZXRTaGFwZUNhY2hlKCBjYWNoZV9rZXksIHNoYXBlICk7DQoJCQl9DQoJCQlicmVhazsNCgkJDQoJCWNhc2UgJ2N5bGluZGVyJzoNCgkJCWNhY2hlX2tleSA9ICdjeWxpbmRlcl8nICsgZGVzY3JpcHRpb24ud2lkdGggKyAnXycgKyBkZXNjcmlwdGlvbi5oZWlnaHQgKyAnXycgKyBkZXNjcmlwdGlvbi5kZXB0aDsNCgkJCWlmICggKCBzaGFwZSA9IGdldFNoYXBlRnJvbUNhY2hlKCBjYWNoZV9rZXkgKSApID09PSBudWxsICkgew0KCQkJCXNoYXBlID0gbmV3IEFtbW8uYnRDeWxpbmRlclNoYXBlKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGVzY3JpcHRpb24ud2lkdGggLyAyLCBkZXNjcmlwdGlvbi5oZWlnaHQgLyAyLCBkZXNjcmlwdGlvbi5kZXB0aCAvIDIgKSk7DQoJCQkJc2V0U2hhcGVDYWNoZSggY2FjaGVfa2V5LCBzaGFwZSApOw0KCQkJfQ0KCQkJYnJlYWs7DQoJCQ0KCQljYXNlICdjYXBzdWxlJzoNCgkJCWNhY2hlX2tleSA9ICdjYXBzdWxlXycgKyBkZXNjcmlwdGlvbi5yYWRpdXMgKyAnXycgKyBkZXNjcmlwdGlvbi5oZWlnaHQ7DQoJCQlpZiAoICggc2hhcGUgPSBnZXRTaGFwZUZyb21DYWNoZSggY2FjaGVfa2V5ICkgKSA9PT0gbnVsbCApIHsNCgkJCQkvLyBJbiBCdWxsZXQsIGNhcHN1bGUgaGVpZ2h0IGV4Y2x1ZGVzIHRoZSBlbmQgc3BoZXJlcw0KCQkJCXNoYXBlID0gbmV3IEFtbW8uYnRDYXBzdWxlU2hhcGUoIGRlc2NyaXB0aW9uLnJhZGl1cywgZGVzY3JpcHRpb24uaGVpZ2h0IC0gMiAqIGRlc2NyaXB0aW9uLnJhZGl1cyApOw0KCQkJCXNldFNoYXBlQ2FjaGUoIGNhY2hlX2tleSwgc2hhcGUgKTsNCgkJCX0NCgkJCWJyZWFrOw0KCQkNCgkJY2FzZSAnY29uZSc6DQoJCQljYWNoZV9rZXkgPSAnY29uZV8nICsgZGVzY3JpcHRpb24ucmFkaXVzICsgJ18nICsgZGVzY3JpcHRpb24uaGVpZ2h0Ow0KCQkJaWYgKCAoIHNoYXBlID0gZ2V0U2hhcGVGcm9tQ2FjaGUoIGNhY2hlX2tleSApICkgPT09IG51bGwgKSB7DQoJCQkJc2hhcGUgPSBuZXcgQW1tby5idENvbmVTaGFwZSggZGVzY3JpcHRpb24ucmFkaXVzLCBkZXNjcmlwdGlvbi5oZWlnaHQgKTsNCgkJCQlzZXRTaGFwZUNhY2hlKCBjYWNoZV9rZXksIHNoYXBlICk7DQoJCQl9DQoJCQlicmVhazsNCgkJDQoJCWNhc2UgJ2NvbmNhdmUnOg0KCQkJdmFyIGksIHRyaWFuZ2xlLCB0cmlhbmdsZV9tZXNoID0gbmV3IEFtbW8uYnRUcmlhbmdsZU1lc2g7DQoJCQlmb3IgKCBpID0gMDsgaSA8IGRlc2NyaXB0aW9uLnRyaWFuZ2xlcy5sZW5ndGg7IGkrKyApIHsNCgkJCQl0cmlhbmdsZSA9IGRlc2NyaXB0aW9uLnRyaWFuZ2xlc1tpXTsNCgkJCQl0cmlhbmdsZV9tZXNoLmFkZFRyaWFuZ2xlKA0KCQkJCQluZXcgQW1tby5idFZlY3RvcjMoIHRyaWFuZ2xlWzBdLngsIHRyaWFuZ2xlWzBdLnksIHRyaWFuZ2xlWzBdLnogKSwNCgkJCQkJbmV3IEFtbW8uYnRWZWN0b3IzKCB0cmlhbmdsZVsxXS54LCB0cmlhbmdsZVsxXS55LCB0cmlhbmdsZVsxXS56ICksDQoJCQkJCW5ldyBBbW1vLmJ0VmVjdG9yMyggdHJpYW5nbGVbMl0ueCwgdHJpYW5nbGVbMl0ueSwgdHJpYW5nbGVbMl0ueiApLA0KCQkJCQl0cnVlDQoJCQkJKTsNCgkJCX0NCg0KCQkJc2hhcGUgPSBuZXcgQW1tby5idEJ2aFRyaWFuZ2xlTWVzaFNoYXBlKA0KCQkJCXRyaWFuZ2xlX21lc2gsDQoJCQkJdHJ1ZSwNCgkJCQl0cnVlDQoJCQkpOw0KCQkJDQoJCQlicmVhazsNCgkJDQoJCWNhc2UgJ2NvbnZleCc6DQoJCQl2YXIgaSwgcG9pbnQsIHNoYXBlID0gbmV3IEFtbW8uYnRDb252ZXhIdWxsU2hhcGU7DQoJCQlmb3IgKCBpID0gMDsgaSA8IGRlc2NyaXB0aW9uLnBvaW50cy5sZW5ndGg7IGkrKyApIHsNCgkJCQlwb2ludCA9IGRlc2NyaXB0aW9uLnBvaW50c1tpXTsNCgkJCQlzaGFwZS5hZGRQb2ludCggbmV3IEFtbW8uYnRWZWN0b3IzKCBwb2ludC54LCBwb2ludC55LCBwb2ludC56ICkgKTsNCgkJCX0NCgkJCWJyZWFrOw0KDQoJCWNhc2UgJ2hlaWdodGZpZWxkJzoNCg0KCQkJdmFyIHB0ciA9IEFtbW8uYWxsb2NhdGUoNCAqIGRlc2NyaXB0aW9uLnhwdHMgKiBkZXNjcmlwdGlvbi55cHRzLCAiZmxvYXQiLCBBbW1vLkFMTE9DX05PUk1BTCk7DQoNCgkJCWZvciAodmFyIGYgPSAwOyBmIDwgZGVzY3JpcHRpb24ucG9pbnRzLmxlbmd0aDsgZisrKSB7DQoJCQkJQW1tby5zZXRWYWx1ZShwdHIgKyBmLCAgZGVzY3JpcHRpb24ucG9pbnRzW2ZdICAsICdmbG9hdCcpOw0KCQkJfQ0KDQoJCQlzaGFwZSA9IG5ldyBBbW1vLmJ0SGVpZ2h0ZmllbGRUZXJyYWluU2hhcGUoDQoJCQkJCWRlc2NyaXB0aW9uLnhwdHMsDQoJCQkJCWRlc2NyaXB0aW9uLnlwdHMsDQoJCQkJCXB0ciwNCgkJCQkJMSwNCgkJCQkJLWRlc2NyaXB0aW9uLmFic01heEhlaWdodCwNCgkJCQkJZGVzY3JpcHRpb24uYWJzTWF4SGVpZ2h0LA0KCQkJCQkyLA0KCQkJCQkwLA0KCQkJCQlmYWxzZQ0KCQkJCSk7DQoNCgkJCXZhciBsb2NhbFNjYWxpbmcgPSBuZXcgQW1tby5idFZlY3RvcjMoZGVzY3JpcHRpb24ueHNpemUvKGRlc2NyaXB0aW9uLnhwdHMgLSAxKSxkZXNjcmlwdGlvbi55c2l6ZS8oZGVzY3JpcHRpb24ueXB0cyAtIDEpLDEpOw0KCQkJc2hhcGUuc2V0TG9jYWxTY2FsaW5nKGxvY2FsU2NhbGluZyk7DQoJCQlicmVhazsNCgkJDQoJCWRlZmF1bHQ6DQoJCQkvLyBOb3QgcmVjb2duaXplZA0KCQkJcmV0dXJuOw0KCQkJYnJlYWs7DQoJfQ0KCQ0KCXJldHVybiBzaGFwZTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMuaW5pdCA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJaW1wb3J0U2NyaXB0cyggcGFyYW1zLmFtbW8gKTsNCglfdHJhbnNmb3JtID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm07DQoJDQoJUkVQT1JUX0NIVU5LU0laRSA9IHBhcmFtcy5yZXBvcnRzaXplIHx8IDUwOw0KCWlmICggc2VsZi53ZWJraXRQb3N0TWVzc2FnZSApIHsNCgkJLy8gVHJhbnNmZXJhYmxlIG1lc3NhZ2VzIGFyZSBzdXBwb3J0ZWQsIHRha2UgYWR2YW50YWdlIG9mIHRoZW0gd2l0aCBUeXBlZEFycmF5cw0KCQl3b3JsZHJlcG9ydCA9IG5ldyBGbG9hdDMyQXJyYXkoMiArIFJFUE9SVF9DSFVOS1NJWkUgKiBXT1JMRFJFUE9SVF9JVEVNU0laRSk7IC8vIG1lc3NhZ2UgaWQgKyAjIG9mIG9iamVjdHMgdG8gcmVwb3J0ICsgY2h1bmsgc2l6ZSAqICMgb2YgdmFsdWVzIHBlciBvYmplY3QNCgkJY29sbGlzaW9ucmVwb3J0ID0gbmV3IEZsb2F0MzJBcnJheSgyICsgUkVQT1JUX0NIVU5LU0laRSAqIENPTExJU0lPTlJFUE9SVF9JVEVNU0laRSk7IC8vIG1lc3NhZ2UgaWQgKyAjIG9mIGNvbGxpc2lvbnMgdG8gcmVwb3J0ICsgY2h1bmsgc2l6ZSAqICMgb2YgdmFsdWVzIHBlciBvYmplY3QNCgl9IGVsc2Ugew0KCQkvLyBUcmFuc2ZlcmFibGUgbWVzc2FnZXMgYXJlIG5vdCBzdXBwb3J0ZWQsIHNlbmQgZGF0YSBhcyBub3JtYWwgYXJyYXlzDQoJCXdvcmxkcmVwb3J0ID0gW107DQoJCWNvbGxpc2lvbnJlcG9ydCA9IFtdOw0KCX0NCgl3b3JsZHJlcG9ydFswXSA9IE1FU1NBR0VfVFlQRVMuV09STERSRVBPUlQ7DQoJY29sbGlzaW9ucmVwb3J0WzBdID0gTUVTU0FHRV9UWVBFUy5DT0xMSVNJT05SRVBPUlQ7DQoJDQoJdmFyIGNvbGxpc2lvbkNvbmZpZ3VyYXRpb24gPSBuZXcgQW1tby5idERlZmF1bHRDb2xsaXNpb25Db25maWd1cmF0aW9uLA0KCQlkaXNwYXRjaGVyID0gbmV3IEFtbW8uYnRDb2xsaXNpb25EaXNwYXRjaGVyKCBjb2xsaXNpb25Db25maWd1cmF0aW9uICksDQoJCXNvbHZlciA9IG5ldyBBbW1vLmJ0U2VxdWVudGlhbEltcHVsc2VDb25zdHJhaW50U29sdmVyLA0KCQlicm9hZHBoYXNlOw0KCQ0KCWlmICggIXBhcmFtcy5icm9hZHBoYXNlICkgcGFyYW1zLmJyb2FkcGhhc2UgPSB7IHR5cGU6ICdkeW5hbWljJyB9Ow0KCXN3aXRjaCAoIHBhcmFtcy5icm9hZHBoYXNlLnR5cGUgKSB7DQoJCWNhc2UgJ3N3ZWVwcHJ1bmUnOg0KCQkJYnJvYWRwaGFzZSA9IG5ldyBBbW1vLmJ0QXhpc1N3ZWVwMygNCgkJCQluZXcgQW1tby5idFZlY3RvcjMoIHBhcmFtcy5icm9hZHBoYXNlLmFhYmJtaW4ueCwgcGFyYW1zLmJyb2FkcGhhc2UuYWFiYm1pbi55LCBwYXJhbXMuYnJvYWRwaGFzZS5hYWJibWF4LnogKSwNCgkJCQluZXcgQW1tby5idFZlY3RvcjMoIHBhcmFtcy5icm9hZHBoYXNlLmFhYmJtYXgueCwgcGFyYW1zLmJyb2FkcGhhc2UuYWFiYm1heC55LCBwYXJhbXMuYnJvYWRwaGFzZS5hYWJibWF4LnogKQ0KCQkJKTsNCgkJCWJyZWFrOw0KCQkNCgkJY2FzZSAnZHluYW1pYyc6DQoJCWRlZmF1bHQ6DQoJCQlicm9hZHBoYXNlID0gbmV3IEFtbW8uYnREYnZ0QnJvYWRwaGFzZTsNCgkJCWJyZWFrOw0KCX0NCgkNCgl3b3JsZCA9IG5ldyBBbW1vLmJ0RGlzY3JldGVEeW5hbWljc1dvcmxkKCBkaXNwYXRjaGVyLCBicm9hZHBoYXNlLCBzb2x2ZXIsIGNvbGxpc2lvbkNvbmZpZ3VyYXRpb24gKTsNCgkNCglmaXhlZFRpbWVTdGVwID0gcGFyYW1zLmZpeGVkVGltZVN0ZXA7DQoJcmF0ZUxpbWl0ID0gcGFyYW1zLnJhdGVMaW1pdDsNCg0KCXRyYW5zZmVyYWJsZU1lc3NhZ2UoeyBjbWQ6ICd3b3JsZFJlYWR5JyB9KTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMucmVnaXN0ZXJNYXRlcmlhbCA9IGZ1bmN0aW9uKCBkZXNjcmlwdGlvbiApIHsNCglfbWF0ZXJpYWxzWyBkZXNjcmlwdGlvbi5pZCBdID0gZGVzY3JpcHRpb247DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLnNldEdyYXZpdHkgPSBmdW5jdGlvbiggZGVzY3JpcHRpb24gKSB7DQoJd29ybGQuc2V0R3Jhdml0eShuZXcgQW1tby5idFZlY3RvcjMoIGRlc2NyaXB0aW9uLngsIGRlc2NyaXB0aW9uLnksIGRlc2NyaXB0aW9uLnogKSk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLmFkZE9iamVjdCA9IGZ1bmN0aW9uKCBkZXNjcmlwdGlvbiApIHsNCgl2YXIgaSwNCgkJbG9jYWxJbmVydGlhLCBzaGFwZSwgbW90aW9uU3RhdGUsIHJiSW5mbywgYm9keTsNCgkNCglzaGFwZSA9IGNyZWF0ZVNoYXBlKCBkZXNjcmlwdGlvbiApOw0KCQ0KCS8vIElmIHRoZXJlIGFyZSBjaGlsZHJlbiB0aGVuIHRoaXMgaXMgYSBjb21wb3VuZCBzaGFwZQ0KCWlmICggZGVzY3JpcHRpb24uY2hpbGRyZW4gKSB7DQoJCXZhciBjb21wb3VuZF9zaGFwZSA9IG5ldyBBbW1vLmJ0Q29tcG91bmRTaGFwZSwgX2NoaWxkOw0KCQljb21wb3VuZF9zaGFwZS5hZGRDaGlsZFNoYXBlKCBfdHJhbnNmb3JtLCBzaGFwZSApOw0KCQkNCgkJZm9yICggaSA9IDA7IGkgPCBkZXNjcmlwdGlvbi5jaGlsZHJlbi5sZW5ndGg7IGkrKyApIHsNCgkJCV9jaGlsZCA9IGRlc2NyaXB0aW9uLmNoaWxkcmVuW2ldOw0KCQkJdmFyIHRyYW5zID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm07DQoJCQl0cmFucy5zZXRJZGVudGl0eSgpOw0KCQkJdHJhbnMuc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggX2NoaWxkLnBvc2l0aW9uX29mZnNldC54LCBfY2hpbGQucG9zaXRpb25fb2Zmc2V0LnksIF9jaGlsZC5wb3NpdGlvbl9vZmZzZXQueiApKTsNCgkJCXRyYW5zLnNldFJvdGF0aW9uKG5ldyBBbW1vLmJ0UXVhdGVybmlvbiggX2NoaWxkLnJvdGF0aW9uLngsIF9jaGlsZC5yb3RhdGlvbi55LCBfY2hpbGQucm90YXRpb24ueiwgX2NoaWxkLnJvdGF0aW9uLncgKSk7DQoJCQkNCgkJCXNoYXBlID0gY3JlYXRlU2hhcGUoIGRlc2NyaXB0aW9uLmNoaWxkcmVuW2ldICk7DQoJCQljb21wb3VuZF9zaGFwZS5hZGRDaGlsZFNoYXBlKCB0cmFucywgc2hhcGUgKTsNCgkJfQ0KCQkNCgkJc2hhcGUgPSBjb21wb3VuZF9zaGFwZTsNCgl9DQoJDQoJbG9jYWxJbmVydGlhID0gbmV3IEFtbW8uYnRWZWN0b3IzKDAsIDAsIDApOyAvLyAjVE9ETzogbG9jYWxJbnRlcnRpYSBpcyB0aGUgbG9jYWwgaW5lcnRpYSB0ZW5zb3IsIHdoYXQgZG9lcyBpdCBkbyBhbmQgc2hvdWxkIGl0IGJlIGEgcGFyYW1ldGVyPw0KCXNoYXBlLmNhbGN1bGF0ZUxvY2FsSW5lcnRpYSggZGVzY3JpcHRpb24ubWFzcywgbG9jYWxJbmVydGlhICk7DQoJDQoJX3RyYW5zZm9ybS5zZXRJZGVudGl0eSgpOw0KCV90cmFuc2Zvcm0uc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGVzY3JpcHRpb24ucG9zaXRpb24ueCwgZGVzY3JpcHRpb24ucG9zaXRpb24ueSwgZGVzY3JpcHRpb24ucG9zaXRpb24ueiApKTsNCglfdHJhbnNmb3JtLnNldFJvdGF0aW9uKG5ldyBBbW1vLmJ0UXVhdGVybmlvbiggZGVzY3JpcHRpb24ucm90YXRpb24ueCwgZGVzY3JpcHRpb24ucm90YXRpb24ueSwgZGVzY3JpcHRpb24ucm90YXRpb24ueiwgZGVzY3JpcHRpb24ucm90YXRpb24udyApKTsNCgkNCgltb3Rpb25TdGF0ZSA9IG5ldyBBbW1vLmJ0RGVmYXVsdE1vdGlvblN0YXRlKCBfdHJhbnNmb3JtICk7IC8vICNUT0RPOiBidERlZmF1bHRNb3Rpb25TdGF0ZSBzdXBwb3J0cyBjZW50ZXIgb2YgbWFzcyBvZmZzZXQgYXMgc2Vjb25kIGFyZ3VtZW50IC0gaW1wbGVtZW50DQoJcmJJbmZvID0gbmV3IEFtbW8uYnRSaWdpZEJvZHlDb25zdHJ1Y3Rpb25JbmZvKCBkZXNjcmlwdGlvbi5tYXNzLCBtb3Rpb25TdGF0ZSwgc2hhcGUsIGxvY2FsSW5lcnRpYSApOw0KCQ0KCWlmICggZGVzY3JpcHRpb24ubWF0ZXJpYWxJZCAhPT0gdW5kZWZpbmVkICkgew0KCQlyYkluZm8uc2V0X21fZnJpY3Rpb24oIF9tYXRlcmlhbHNbIGRlc2NyaXB0aW9uLm1hdGVyaWFsSWQgXS5mcmljdGlvbiApOw0KCQlyYkluZm8uc2V0X21fcmVzdGl0dXRpb24oIF9tYXRlcmlhbHNbIGRlc2NyaXB0aW9uLm1hdGVyaWFsSWQgXS5yZXN0aXR1dGlvbiApOw0KCX0NCgkNCglib2R5ID0gbmV3IEFtbW8uYnRSaWdpZEJvZHkoIHJiSW5mbyApOw0KCQ0KCWlmICggdHlwZW9mIGRlc2NyaXB0aW9uLmNvbGxpc2lvbl9mbGFncyAhPT0gJ3VuZGVmaW5lZCcgKSB7DQoJCWJvZHkuc2V0Q29sbGlzaW9uRmxhZ3MoIGRlc2NyaXB0aW9uLmNvbGxpc2lvbl9mbGFncyApOw0KCX0NCg0KCXdvcmxkLmFkZFJpZ2lkQm9keSggYm9keSApOw0KDQoJYm9keS5pZCA9IGRlc2NyaXB0aW9uLmlkOw0KCV9vYmplY3RzWyBib2R5LmlkIF0gPSBib2R5Ow0KCV9vYmplY3RzX2FtbW9bYm9keS5hXSA9IGJvZHkuaWQ7DQoJX251bV9vYmplY3RzKys7DQoNCgl0cmFuc2ZlcmFibGVNZXNzYWdlKHsgY21kOiAnb2JqZWN0UmVhZHknLCBwYXJhbXM6IGJvZHkuaWQgfSk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLmFkZFZlaGljbGUgPSBmdW5jdGlvbiggZGVzY3JpcHRpb24gKSB7DQoJdmFyIHZlaGljbGVfdHVuaW5nID0gbmV3IEFtbW8uYnRWZWhpY2xlVHVuaW5nKCksDQoJCXZlaGljbGU7DQoNCgl2ZWhpY2xlX3R1bmluZy5zZXRfbV9zdXNwZW5zaW9uU3RpZmZuZXNzKCBkZXNjcmlwdGlvbi5zdXNwZW5zaW9uX3N0aWZmbmVzcyApOw0KCXZlaGljbGVfdHVuaW5nLnNldF9tX3N1c3BlbnNpb25Db21wcmVzc2lvbiggZGVzY3JpcHRpb24uc3VzcGVuc2lvbl9jb21wcmVzc2lvbiApOw0KCXZlaGljbGVfdHVuaW5nLnNldF9tX3N1c3BlbnNpb25EYW1waW5nKCBkZXNjcmlwdGlvbi5zdXNwZW5zaW9uX2RhbXBpbmcgKTsNCgl2ZWhpY2xlX3R1bmluZy5zZXRfbV9tYXhTdXNwZW5zaW9uVHJhdmVsQ20oIGRlc2NyaXB0aW9uLm1heF9zdXNwZW5zaW9uX3RyYXZlbCApOw0KCXZlaGljbGVfdHVuaW5nLnNldF9tX21heFN1c3BlbnNpb25Gb3JjZSggZGVzY3JpcHRpb24ubWF4X3N1c3BlbnNpb25fZm9yY2UgKTsNCg0KCXZlaGljbGUgPSBuZXcgQW1tby5idFJheWNhc3RWZWhpY2xlKCB2ZWhpY2xlX3R1bmluZywgX29iamVjdHNbIGRlc2NyaXB0aW9uLnJpZ2lkQm9keSBdLCBuZXcgQW1tby5idERlZmF1bHRWZWhpY2xlUmF5Y2FzdGVyKCB3b3JsZCApICk7DQoJdmVoaWNsZS50dW5pbmcgPSB2ZWhpY2xlX3R1bmluZzsNCg0KCV9vYmplY3RzWyBkZXNjcmlwdGlvbi5yaWdpZEJvZHkgXS5zZXRBY3RpdmF0aW9uU3RhdGUoIDQgKTsNCgl2ZWhpY2xlLnNldENvb3JkaW5hdGVTeXN0ZW0oIDAsIDEsIDIgKTsNCg0KCXdvcmxkLmFkZFZlaGljbGUoIHZlaGljbGUgKTsNCglfdmVoaWNsZXNbIGRlc2NyaXB0aW9uLmlkIF0gPSB2ZWhpY2xlOw0KfTsNCnB1YmxpY19mdW5jdGlvbnMucmVtb3ZlVmVoaWNsZSA9IGZ1bmN0aW9uKCBkZXNjcmlwdGlvbiApIHsNCglkZWxldGUgX3ZlaGljbGVzWyBkZXNjcmlwdGlvbi5pZCBdOw0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5hZGRXaGVlbCA9IGZ1bmN0aW9uKCBkZXNjcmlwdGlvbiApIHsNCglpZiAoIF92ZWhpY2xlc1tkZXNjcmlwdGlvbi5pZF0gIT09IHVuZGVmaW5lZCApIHsNCgkJdmFyIHR1bmluZyA9IF92ZWhpY2xlc1tkZXNjcmlwdGlvbi5pZF0udHVuaW5nOw0KCQlpZiAoIGRlc2NyaXB0aW9uLnR1bmluZyAhPT0gdW5kZWZpbmVkICkgew0KCQkJdHVuaW5nID0gbmV3IEFtbW8uYnRWZWhpY2xlVHVuaW5nKCk7DQoJCQl0dW5pbmcuc2V0X21fc3VzcGVuc2lvblN0aWZmbmVzcyggZGVzY3JpcHRpb24udHVuaW5nLnN1c3BlbnNpb25fc3RpZmZuZXNzICk7DQoJCQl0dW5pbmcuc2V0X21fc3VzcGVuc2lvbkNvbXByZXNzaW9uKCBkZXNjcmlwdGlvbi50dW5pbmcuc3VzcGVuc2lvbl9jb21wcmVzc2lvbiApOw0KCQkJdHVuaW5nLnNldF9tX3N1c3BlbnNpb25EYW1waW5nKCBkZXNjcmlwdGlvbi50dW5pbmcuc3VzcGVuc2lvbl9kYW1waW5nICk7DQoJCQl0dW5pbmcuc2V0X21fbWF4U3VzcGVuc2lvblRyYXZlbENtKCBkZXNjcmlwdGlvbi50dW5pbmcubWF4X3N1c3BlbnNpb25fdHJhdmVsICk7DQoJCQl0dW5pbmcuc2V0X21fbWF4U3VzcGVuc2lvbkZvcmNlKCBkZXNjcmlwdGlvbi50dW5pbmcubWF4X3N1c3BlbnNpb25fZm9yY2UgKTsNCgkJfQ0KCQlfdmVoaWNsZXNbZGVzY3JpcHRpb24uaWRdLmFkZFdoZWVsKA0KCQkJbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXNjcmlwdGlvbi5jb25uZWN0aW9uX3BvaW50LngsIGRlc2NyaXB0aW9uLmNvbm5lY3Rpb25fcG9pbnQueSwgZGVzY3JpcHRpb24uY29ubmVjdGlvbl9wb2ludC56ICksDQoJCQluZXcgQW1tby5idFZlY3RvcjMoIGRlc2NyaXB0aW9uLndoZWVsX2RpcmVjdGlvbi54LCBkZXNjcmlwdGlvbi53aGVlbF9kaXJlY3Rpb24ueSwgZGVzY3JpcHRpb24ud2hlZWxfZGlyZWN0aW9uLnogKSwNCgkJCW5ldyBBbW1vLmJ0VmVjdG9yMyggZGVzY3JpcHRpb24ud2hlZWxfYXhsZS54LCBkZXNjcmlwdGlvbi53aGVlbF9heGxlLnksIGRlc2NyaXB0aW9uLndoZWVsX2F4bGUueiApLA0KCQkJZGVzY3JpcHRpb24uc3VzcGVuc2lvbl9yZXN0X2xlbmd0aCwNCgkJCWRlc2NyaXB0aW9uLndoZWVsX3JhZGl1cywNCgkJCXR1bmluZywNCgkJCWRlc2NyaXB0aW9uLmlzX2Zyb250X3doZWVsDQoJCSk7DQoJfQ0KDQoJX251bV93aGVlbHMrKzsNCg0KCWlmICggc2VsZi53ZWJraXRQb3N0TWVzc2FnZSApIHsNCgkJdmVoaWNsZXJlcG9ydCA9IG5ldyBGbG9hdDMyQXJyYXkoMSArIF9udW1fd2hlZWxzICogVkVISUNMRVJFUE9SVF9JVEVNU0laRSk7IC8vIG1lc3NhZ2UgaWQgJiAoICMgb2Ygb2JqZWN0cyB0byByZXBvcnQgKiAjIG9mIHZhbHVlcyBwZXIgb2JqZWN0ICkNCgkJdmVoaWNsZXJlcG9ydFswXSA9IE1FU1NBR0VfVFlQRVMuVkVISUNMRVJFUE9SVDsNCgl9IGVsc2Ugew0KCQl2ZWhpY2xlcmVwb3J0ID0gWyBNRVNTQUdFX1RZUEVTLlZFSElDTEVSRVBPUlQgXTsNCgl9DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLnNldFN0ZWVyaW5nID0gZnVuY3Rpb24oIGRldGFpbHMgKSB7DQoJaWYgKCBfdmVoaWNsZXNbZGV0YWlscy5pZF0gIT09IHVuZGVmaW5lZCApIHsNCgkJX3ZlaGljbGVzW2RldGFpbHMuaWRdLnNldFN0ZWVyaW5nVmFsdWUoIGRldGFpbHMuc3RlZXJpbmcsIGRldGFpbHMud2hlZWwgKTsNCgl9DQp9Ow0KcHVibGljX2Z1bmN0aW9ucy5zZXRCcmFrZSA9IGZ1bmN0aW9uKCBkZXRhaWxzICkgew0KCWlmICggX3ZlaGljbGVzW2RldGFpbHMuaWRdICE9PSB1bmRlZmluZWQgKSB7DQoJCV92ZWhpY2xlc1tkZXRhaWxzLmlkXS5zZXRCcmFrZSggZGV0YWlscy5icmFrZSwgZGV0YWlscy53aGVlbCApOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLmFwcGx5RW5naW5lRm9yY2UgPSBmdW5jdGlvbiggZGV0YWlscyApIHsNCglpZiAoIF92ZWhpY2xlc1tkZXRhaWxzLmlkXSAhPT0gdW5kZWZpbmVkICkgew0KCQlfdmVoaWNsZXNbZGV0YWlscy5pZF0uYXBwbHlFbmdpbmVGb3JjZSggZGV0YWlscy5mb3JjZSwgZGV0YWlscy53aGVlbCApOw0KCX0NCn07DQoNCnB1YmxpY19mdW5jdGlvbnMucmVtb3ZlT2JqZWN0ID0gZnVuY3Rpb24oIGRldGFpbHMgKSB7DQoJd29ybGQucmVtb3ZlUmlnaWRCb2R5KCBfb2JqZWN0c1tkZXRhaWxzLmlkXSApOw0KCWRlbGV0ZSBfb2JqZWN0c1tkZXRhaWxzLmlkXTsNCglfbnVtX29iamVjdHMtLTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oIGRldGFpbHMgKSB7DQoJX29iamVjdCA9IF9vYmplY3RzW2RldGFpbHMuaWRdOw0KCV9vYmplY3QuZ2V0TW90aW9uU3RhdGUoKS5nZXRXb3JsZFRyYW5zZm9ybSggX3RyYW5zZm9ybSApOw0KCQ0KCWlmICggZGV0YWlscy5wb3MgKSB7DQoJCV90cmFuc2Zvcm0uc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3MueCwgZGV0YWlscy5wb3MueSwgZGV0YWlscy5wb3MueiApKTsNCgl9DQoJDQoJaWYgKCBkZXRhaWxzLnF1YXQgKSB7DQoJCV90cmFuc2Zvcm0uc2V0Um90YXRpb24obmV3IEFtbW8uYnRRdWF0ZXJuaW9uKCBkZXRhaWxzLnF1YXQueCwgZGV0YWlscy5xdWF0LnksIGRldGFpbHMucXVhdC56LCBkZXRhaWxzLnF1YXQudyApKTsNCgl9DQoJDQoJX29iamVjdC5zZXRXb3JsZFRyYW5zZm9ybSggX3RyYW5zZm9ybSApOw0KCV9vYmplY3QuYWN0aXZhdGUoKTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMudXBkYXRlTWFzcyA9IGZ1bmN0aW9uKCBkZXRhaWxzICkgew0KCS8vICNUT0RPOiBjaGFuZ2luZyBhIHN0YXRpYyBvYmplY3QgaW50byBkeW5hbWljIGlzIGJ1Z2d5DQoJX29iamVjdCA9IF9vYmplY3RzW2RldGFpbHMuaWRdOw0KCQ0KCS8vIFBlciBodHRwOi8vd3d3LmJ1bGxldHBoeXNpY3Mub3JnL0J1bGxldC9waHBCQjMvdmlld3RvcGljLnBocD9wPSZmPTkmdD0zNjYzI3AxMzgxNg0KCXdvcmxkLnJlbW92ZVJpZ2lkQm9keSggX29iamVjdCApOw0KCV9vYmplY3Quc2V0TWFzc1Byb3BzKCBkZXRhaWxzLm1hc3MsIG5ldyBBbW1vLmJ0VmVjdG9yMygwLCAwLCAwKSApOw0KCXdvcmxkLmFkZFJpZ2lkQm9keSggX29iamVjdCApOw0KCV9vYmplY3QuYWN0aXZhdGUoKTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMuYXBwbHlDZW50cmFsSW1wdWxzZSA9IGZ1bmN0aW9uICggZGV0YWlscyApIHsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5hcHBseUNlbnRyYWxJbXB1bHNlKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy54LCBkZXRhaWxzLnksIGRldGFpbHMueiApKTsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5hY3RpdmF0ZSgpOw0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5hcHBseUltcHVsc2UgPSBmdW5jdGlvbiAoIGRldGFpbHMgKSB7DQoJX29iamVjdHNbZGV0YWlscy5pZF0uYXBwbHlJbXB1bHNlKA0KCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMuaW1wdWxzZV94LCBkZXRhaWxzLmltcHVsc2VfeSwgZGV0YWlscy5pbXB1bHNlX3ogKSwNCgkJbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXRhaWxzLngsIGRldGFpbHMueSwgZGV0YWlscy56ICkNCgkpOw0KCV9vYmplY3RzW2RldGFpbHMuaWRdLmFjdGl2YXRlKCk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLmFwcGx5Q2VudHJhbEZvcmNlID0gZnVuY3Rpb24gKCBkZXRhaWxzICkgew0KCV9vYmplY3RzW2RldGFpbHMuaWRdLmFwcGx5Q2VudHJhbEZvcmNlKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy54LCBkZXRhaWxzLnksIGRldGFpbHMueiApKTsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5hY3RpdmF0ZSgpOw0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5hcHBseUZvcmNlID0gZnVuY3Rpb24gKCBkZXRhaWxzICkgew0KCV9vYmplY3RzW2RldGFpbHMuaWRdLmFwcGx5Rm9yY2UoDQoJCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMuZm9yY2VfeCwgZGV0YWlscy5mb3JjZV95LCBkZXRhaWxzLmZvcmNlX3ogKSwNCgkJCW5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy54LCBkZXRhaWxzLnksIGRldGFpbHMueiApDQoJKTsJDQoJX29iamVjdHNbZGV0YWlscy5pZF0uYWN0aXZhdGUoKTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMuc2V0QW5ndWxhclZlbG9jaXR5ID0gZnVuY3Rpb24gKCBkZXRhaWxzICkgew0KCV9vYmplY3RzW2RldGFpbHMuaWRdLnNldEFuZ3VsYXJWZWxvY2l0eSgNCgkJbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXRhaWxzLngsIGRldGFpbHMueSwgZGV0YWlscy56ICkNCgkpOw0KCV9vYmplY3RzW2RldGFpbHMuaWRdLmFjdGl2YXRlKCk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLnNldExpbmVhclZlbG9jaXR5ID0gZnVuY3Rpb24gKCBkZXRhaWxzICkgew0KCV9vYmplY3RzW2RldGFpbHMuaWRdLnNldExpbmVhclZlbG9jaXR5KA0KCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMueCwgZGV0YWlscy55LCBkZXRhaWxzLnogKQ0KCSk7DQoJX29iamVjdHNbZGV0YWlscy5pZF0uYWN0aXZhdGUoKTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMuc2V0QW5ndWxhckZhY3RvciA9IGZ1bmN0aW9uICggZGV0YWlscyApIHsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5zZXRBbmd1bGFyRmFjdG9yKA0KCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMueCwgZGV0YWlscy55LCBkZXRhaWxzLnogKQ0KCSk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLnNldExpbmVhckZhY3RvciA9IGZ1bmN0aW9uICggZGV0YWlscyApIHsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5zZXRMaW5lYXJGYWN0b3IoDQoJCW5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy54LCBkZXRhaWxzLnksIGRldGFpbHMueiApDQoJKTsNCn07DQoNCnB1YmxpY19mdW5jdGlvbnMuc2V0RGFtcGluZyA9IGZ1bmN0aW9uICggZGV0YWlscyApIHsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5zZXREYW1waW5nKCBkZXRhaWxzLmxpbmVhciwgZGV0YWlscy5hbmd1bGFyICk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLnNldENjZE1vdGlvblRocmVzaG9sZCA9IGZ1bmN0aW9uICggZGV0YWlscyApIHsNCglfb2JqZWN0c1tkZXRhaWxzLmlkXS5zZXRDY2RNb3Rpb25UaHJlc2hvbGQoIGRldGFpbHMudGhyZXNob2xkICk7DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLnNldENjZFN3ZXB0U3BoZXJlUmFkaXVzID0gZnVuY3Rpb24gKCBkZXRhaWxzICkgew0KCV9vYmplY3RzW2RldGFpbHMuaWRdLnNldENjZFN3ZXB0U3BoZXJlUmFkaXVzKCBkZXRhaWxzLnJhZGl1cyApOw0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5hZGRDb25zdHJhaW50ID0gZnVuY3Rpb24gKCBkZXRhaWxzICkgew0KCXZhciBjb25zdHJhaW50Ow0KCQ0KCXN3aXRjaCAoIGRldGFpbHMudHlwZSApIHsNCgkJDQoJCWNhc2UgJ3BvaW50JzoNCgkJCWlmICggZGV0YWlscy5vYmplY3RiID09PSB1bmRlZmluZWQgKSB7DQoJCQkJY29uc3RyYWludCA9IG5ldyBBbW1vLmJ0UG9pbnQyUG9pbnRDb25zdHJhaW50KA0KCQkJCQlfb2JqZWN0c1sgZGV0YWlscy5vYmplY3RhIF0sDQoJCQkJCW5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3NpdGlvbmEueCwgZGV0YWlscy5wb3NpdGlvbmEueSwgZGV0YWlscy5wb3NpdGlvbmEueiApDQoJCQkJKTsNCgkJCX0gZWxzZSB7DQoJCQkJY29uc3RyYWludCA9IG5ldyBBbW1vLmJ0UG9pbnQyUG9pbnRDb25zdHJhaW50KA0KCQkJCQlfb2JqZWN0c1sgZGV0YWlscy5vYmplY3RhIF0sDQoJCQkJCV9vYmplY3RzWyBkZXRhaWxzLm9iamVjdGIgXSwNCgkJCQkJbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXRhaWxzLnBvc2l0aW9uYS54LCBkZXRhaWxzLnBvc2l0aW9uYS55LCBkZXRhaWxzLnBvc2l0aW9uYS56ICksDQoJCQkJCW5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3NpdGlvbmIueCwgZGV0YWlscy5wb3NpdGlvbmIueSwgZGV0YWlscy5wb3NpdGlvbmIueiApDQoJCQkJKTsNCg0KCQkJfQ0KCQkJYnJlYWs7DQoJCQ0KCQljYXNlICdoaW5nZSc6DQoJCQlpZiAoIGRldGFpbHMub2JqZWN0YiA9PT0gdW5kZWZpbmVkICkgew0KCQkJCWNvbnN0cmFpbnQgPSBuZXcgQW1tby5idEhpbmdlQ29uc3RyYWludCgNCgkJCQkJX29iamVjdHNbIGRldGFpbHMub2JqZWN0YSBdLA0KCQkJCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMucG9zaXRpb25hLngsIGRldGFpbHMucG9zaXRpb25hLnksIGRldGFpbHMucG9zaXRpb25hLnogKSwNCgkJCQkJbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXRhaWxzLmF4aXMueCwgZGV0YWlscy5heGlzLnksIGRldGFpbHMuYXhpcy56ICkNCgkJCQkpOw0KCQkJfSBlbHNlIHsNCgkJCQljb25zdHJhaW50ID0gbmV3IEFtbW8uYnRIaW5nZUNvbnN0cmFpbnQoDQoJCQkJCV9vYmplY3RzWyBkZXRhaWxzLm9iamVjdGEgXSwNCgkJCQkJX29iamVjdHNbIGRldGFpbHMub2JqZWN0YiBdLA0KCQkJCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMucG9zaXRpb25hLngsIGRldGFpbHMucG9zaXRpb25hLnksIGRldGFpbHMucG9zaXRpb25hLnogKSwNCgkJCQkJbmV3IEFtbW8uYnRWZWN0b3IzKCBkZXRhaWxzLnBvc2l0aW9uYi54LCBkZXRhaWxzLnBvc2l0aW9uYi55LCBkZXRhaWxzLnBvc2l0aW9uYi56ICksDQoJCQkJCW5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5heGlzLngsIGRldGFpbHMuYXhpcy55LCBkZXRhaWxzLmF4aXMueiApLA0KCQkJCQluZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMuYXhpcy54LCBkZXRhaWxzLmF4aXMueSwgZGV0YWlscy5heGlzLnogKQ0KCQkJCSk7DQoNCgkJCX0NCgkJCWJyZWFrOw0KCQkNCgkJY2FzZSAnc2xpZGVyJzoNCgkJCXZhciB0cmFuc2Zvcm1hLCB0cmFuc2Zvcm1iLCByb3RhdGlvbjsNCgkJCQ0KCQkJdHJhbnNmb3JtYSA9IG5ldyBBbW1vLmJ0VHJhbnNmb3JtKCk7DQoJCQl0cmFuc2Zvcm1hLnNldE9yaWdpbihuZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMucG9zaXRpb25hLngsIGRldGFpbHMucG9zaXRpb25hLnksIGRldGFpbHMucG9zaXRpb25hLnogKSk7DQoJCQkNCgkJCXZhciByb3RhdGlvbiA9IHRyYW5zZm9ybWEuZ2V0Um90YXRpb24oKTsNCgkJCXJvdGF0aW9uLnNldEV1bGVyKCBkZXRhaWxzLmF4aXMueCwgZGV0YWlscy5heGlzLnksIGRldGFpbHMuYXhpcy56ICk7DQoJCQl0cmFuc2Zvcm1hLnNldFJvdGF0aW9uKCByb3RhdGlvbiApOw0KCQkJDQoJCQlpZiAoIGRldGFpbHMub2JqZWN0YiApIHsNCgkJCQl0cmFuc2Zvcm1iID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm0oKTsNCgkJCQl0cmFuc2Zvcm1iLnNldE9yaWdpbihuZXcgQW1tby5idFZlY3RvcjMoIGRldGFpbHMucG9zaXRpb25iLngsIGRldGFpbHMucG9zaXRpb25iLnksIGRldGFpbHMucG9zaXRpb25iLnogKSk7DQoJCQkJDQoJCQkJcm90YXRpb24gPSB0cmFuc2Zvcm1iLmdldFJvdGF0aW9uKCk7DQoJCQkJcm90YXRpb24uc2V0RXVsZXIoIGRldGFpbHMuYXhpcy54LCBkZXRhaWxzLmF4aXMueSwgZGV0YWlscy5heGlzLnogKTsNCgkJCQl0cmFuc2Zvcm1iLnNldFJvdGF0aW9uKCByb3RhdGlvbiApOw0KCQkJCQ0KCQkJCWNvbnN0cmFpbnQgPSBuZXcgQW1tby5idFNsaWRlckNvbnN0cmFpbnQoDQoJCQkJCV9vYmplY3RzWyBkZXRhaWxzLm9iamVjdGEgXSwNCgkJCQkJX29iamVjdHNbIGRldGFpbHMub2JqZWN0YiBdLA0KCQkJCQl0cmFuc2Zvcm1hLA0KCQkJCQl0cmFuc2Zvcm1iLA0KCQkJCQl0cnVlDQoJCQkJKTsNCgkJCX0gZWxzZSB7DQoJCQkJY29uc3RyYWludCA9IG5ldyBBbW1vLmJ0U2xpZGVyQ29uc3RyYWludCgNCgkJCQkJX29iamVjdHNbIGRldGFpbHMub2JqZWN0YSBdLA0KCQkJCQl0cmFuc2Zvcm1hLA0KCQkJCQl0cnVlDQoJCQkJKTsNCgkJCX0NCgkJCWJyZWFrOw0KCQkNCgkJY2FzZSAnY29uZXR3aXN0JzoNCgkJCXZhciB0cmFuc2Zvcm1hLCB0cmFuc2Zvcm1iOw0KCQkJDQoJCQl0cmFuc2Zvcm1hID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm0oKTsNCgkJCXRyYW5zZm9ybWEuc2V0SWRlbnRpdHkoKTsNCgkJCQ0KCQkJdHJhbnNmb3JtYiA9IG5ldyBBbW1vLmJ0VHJhbnNmb3JtKCk7DQoJCQl0cmFuc2Zvcm1iLnNldElkZW50aXR5KCk7DQoJCQkNCgkJCXRyYW5zZm9ybWEuc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3NpdGlvbmEueCwgZGV0YWlscy5wb3NpdGlvbmEueSwgZGV0YWlscy5wb3NpdGlvbmEueiApKTsNCgkJCXRyYW5zZm9ybWIuc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3NpdGlvbmIueCwgZGV0YWlscy5wb3NpdGlvbmIueSwgZGV0YWlscy5wb3NpdGlvbmIueiApKTsNCgkJCQ0KCQkJdmFyIHJvdGF0aW9uID0gdHJhbnNmb3JtYS5nZXRSb3RhdGlvbigpOw0KCQkJcm90YXRpb24uc2V0RXVsZXJaWVgoIC1kZXRhaWxzLmF4aXNhLnosIC1kZXRhaWxzLmF4aXNhLnksIC1kZXRhaWxzLmF4aXNhLnggKTsNCgkJCXRyYW5zZm9ybWEuc2V0Um90YXRpb24oIHJvdGF0aW9uICk7DQoJCQkNCgkJCXJvdGF0aW9uID0gdHJhbnNmb3JtYi5nZXRSb3RhdGlvbigpOw0KCQkJcm90YXRpb24uc2V0RXVsZXJaWVgoIC1kZXRhaWxzLmF4aXNiLnosIC1kZXRhaWxzLmF4aXNiLnksIC1kZXRhaWxzLmF4aXNiLnggKTsNCgkJCXRyYW5zZm9ybWIuc2V0Um90YXRpb24oIHJvdGF0aW9uICk7DQoJCQkNCgkJCWNvbnN0cmFpbnQgPSBuZXcgQW1tby5idENvbmVUd2lzdENvbnN0cmFpbnQoDQoJCQkJX29iamVjdHNbIGRldGFpbHMub2JqZWN0YSBdLA0KCQkJCV9vYmplY3RzWyBkZXRhaWxzLm9iamVjdGIgXSwNCgkJCQl0cmFuc2Zvcm1hLA0KCQkJCXRyYW5zZm9ybWINCgkJCSk7DQoJCQkNCgkJCWNvbnN0cmFpbnQuc2V0TGltaXQoIE1hdGguUEksIDAsIE1hdGguUEkgKTsNCgkJCWJyZWFrOw0KCQkNCgkJY2FzZSAnZG9mJzoNCgkJCXZhciB0cmFuc2Zvcm1hLCB0cmFuc2Zvcm1iLCByb3RhdGlvbjsNCgkJDQoJCQl0cmFuc2Zvcm1hID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm0oKTsNCgkJCXRyYW5zZm9ybWEuc2V0SWRlbnRpdHkoKTsNCgkJCXRyYW5zZm9ybWEuc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3NpdGlvbmEueCwgZGV0YWlscy5wb3NpdGlvbmEueSwgZGV0YWlscy5wb3NpdGlvbmEueiApKTsNCgkJCQ0KCQkJcm90YXRpb24gPSB0cmFuc2Zvcm1hLmdldFJvdGF0aW9uKCk7DQoJCQlyb3RhdGlvbi5zZXRFdWxlclpZWCggLWRldGFpbHMuYXhpc2EueiwgLWRldGFpbHMuYXhpc2EueSwgLWRldGFpbHMuYXhpc2EueCApOw0KCQkJdHJhbnNmb3JtYS5zZXRSb3RhdGlvbiggcm90YXRpb24gKTsNCgkJCQ0KCQkJaWYgKCBkZXRhaWxzLm9iamVjdGIgKSB7DQoJCQkJdHJhbnNmb3JtYiA9IG5ldyBBbW1vLmJ0VHJhbnNmb3JtKCk7DQoJCQkJdHJhbnNmb3JtYi5zZXRJZGVudGl0eSgpOw0KCQkJCXRyYW5zZm9ybWIuc2V0T3JpZ2luKG5ldyBBbW1vLmJ0VmVjdG9yMyggZGV0YWlscy5wb3NpdGlvbmIueCwgZGV0YWlscy5wb3NpdGlvbmIueSwgZGV0YWlscy5wb3NpdGlvbmIueiApKTsNCgkJCQkNCgkJCQlyb3RhdGlvbiA9IHRyYW5zZm9ybWIuZ2V0Um90YXRpb24oKTsNCgkJCQlyb3RhdGlvbi5zZXRFdWxlclpZWCggLWRldGFpbHMuYXhpc2IueiwgLWRldGFpbHMuYXhpc2IueSwgLWRldGFpbHMuYXhpc2IueCApOw0KCQkJCXRyYW5zZm9ybWIuc2V0Um90YXRpb24oIHJvdGF0aW9uICk7DQoJCQkJDQoJCQkJY29uc3RyYWludCA9IG5ldyBBbW1vLmJ0R2VuZXJpYzZEb2ZDb25zdHJhaW50KA0KCQkJCQlfb2JqZWN0c1sgZGV0YWlscy5vYmplY3RhIF0sDQoJCQkJCV9vYmplY3RzWyBkZXRhaWxzLm9iamVjdGIgXSwNCgkJCQkJdHJhbnNmb3JtYSwNCgkJCQkJdHJhbnNmb3JtYg0KCQkJCSk7DQoJCQl9IGVsc2Ugew0KCQkJCWNvbnN0cmFpbnQgPSBuZXcgQW1tby5idEdlbmVyaWM2RG9mQ29uc3RyYWludCgNCgkJCQkJX29iamVjdHNbIGRldGFpbHMub2JqZWN0YSBdLA0KCQkJCQl0cmFuc2Zvcm1hDQoJCQkJKTsNCgkJCX0NCgkJCWJyZWFrOw0KCQkNCgkJZGVmYXVsdDoNCgkJCXJldHVybjsNCgkJDQoJfTsNCgkNCgl3b3JsZC5hZGRDb25zdHJhaW50KCBjb25zdHJhaW50ICk7DQoNCgljb25zdHJhaW50LmVuYWJsZUZlZWRiYWNrKCk7DQoJX2NvbnN0cmFpbnRzWyBkZXRhaWxzLmlkIF0gPSBjb25zdHJhaW50Ow0KCV9udW1fY29uc3RyYWludHMrKzsNCg0KCWlmICggc2VsZi53ZWJraXRQb3N0TWVzc2FnZSApIHsNCgkJY29uc3RyYWludHJlcG9ydCA9IG5ldyBGbG9hdDMyQXJyYXkoMSArIF9udW1fY29uc3RyYWludHMgKiBDT05TVFJBSU5UUkVQT1JUX0lURU1TSVpFKTsgLy8gbWVzc2FnZSBpZCAmICggIyBvZiBvYmplY3RzIHRvIHJlcG9ydCAqICMgb2YgdmFsdWVzIHBlciBvYmplY3QgKQ0KCQljb25zdHJhaW50cmVwb3J0WzBdID0gTUVTU0FHRV9UWVBFUy5DT05TVFJBSU5UUkVQT1JUOw0KCX0gZWxzZSB7DQoJCWNvbnN0cmFpbnRyZXBvcnQgPSBbIE1FU1NBR0VfVFlQRVMuQ09OU1RSQUlOVFJFUE9SVCBdOw0KCX0NCn07DQoNCnB1YmxpY19mdW5jdGlvbnMucmVtb3ZlQ29uc3RyYWludCA9IGZ1bmN0aW9uKCBkZXRhaWxzICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBkZXRhaWxzLmlkIF07DQoJaWYgKCBjb25zdHJhaW50ICE9PSB1bmRlZmluZWQgKSB7DQoJCXdvcmxkLnJlbW92ZUNvbnN0cmFpbnQoIGNvbnN0cmFpbnQgKTsNCgkJZGVsZXRlIF9jb25zdHJhaW50c1sgZGV0YWlscy5pZCBdOw0KCQlfbnVtX2NvbnN0cmFpbnRzLS07DQoJfQ0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5jb25zdHJhaW50X3NldEJyZWFraW5nSW1wdWxzZVRocmVzaG9sZCA9IGZ1bmN0aW9uKCBkZXRhaWxzICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBkZXRhaWxzLmlkIF07DQoJaWYgKCBjb25zdHJhaW50ICE9PSB1bmRlZmluZCApIHsNCgkJY29uc3RyYWludC5zZXRCcmVha2luZ0ltcHVsc2VUaHJlc2hvbGQoIGRldGFpbHMudGhyZXNob2xkICk7DQoJfQ0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5zaW11bGF0ZSA9IGZ1bmN0aW9uIHNpbXVsYXRlKCBwYXJhbXMgKSB7DQoJaWYgKCB3b3JsZCApIHsNCgkJcGFyYW1zID0gcGFyYW1zIHx8IHt9Ow0KCQkNCgkJaWYgKCAhcGFyYW1zLnRpbWVTdGVwICkgew0KCQkJaWYgKCBsYXN0X3NpbXVsYXRpb25fdGltZSApIHsNCgkJCQlwYXJhbXMudGltZVN0ZXAgPSAwOw0KCQkJCXdoaWxlICggcGFyYW1zLnRpbWVTdGVwICsgbGFzdF9zaW11bGF0aW9uX2R1cmF0aW9uIDw9IGZpeGVkVGltZVN0ZXAgKSB7DQoJCQkJCXBhcmFtcy50aW1lU3RlcCA9ICggRGF0ZS5ub3coKSAtIGxhc3Rfc2ltdWxhdGlvbl90aW1lICkgLyAxMDAwOyAvLyB0aW1lIHNpbmNlIGxhc3Qgc2ltdWxhdGlvbg0KCQkJCX0NCgkJCX0gZWxzZSB7DQoJCQkJcGFyYW1zLnRpbWVTdGVwID0gZml4ZWRUaW1lU3RlcDsgLy8gaGFuZGxlIGZpcnN0IGZyYW1lDQoJCQl9DQoJCX0gZWxzZSB7DQoJCQlpZiAoIHBhcmFtcy50aW1lU3RlcCA8IGZpeGVkVGltZVN0ZXAgKSB7DQoJCQkJcGFyYW1zLnRpbWVTdGVwID0gZml4ZWRUaW1lU3RlcDsNCgkJCX0NCgkJfQ0KDQoJCXBhcmFtcy5tYXhTdWJTdGVwcyA9IHBhcmFtcy5tYXhTdWJTdGVwcyB8fCBNYXRoLmNlaWwoIHBhcmFtcy50aW1lU3RlcCAvIGZpeGVkVGltZVN0ZXAgKTsgLy8gSWYgbWF4U3ViU3RlcHMgaXMgbm90IGRlZmluZWQsIGtlZXAgdGhlIHNpbXVsYXRpb24gZnVsbHkgdXAgdG8gZGF0ZQ0KDQoJCWxhc3Rfc2ltdWxhdGlvbl9kdXJhdGlvbiA9IERhdGUubm93KCk7DQoJCXdvcmxkLnN0ZXBTaW11bGF0aW9uKCBwYXJhbXMudGltZVN0ZXAsIHBhcmFtcy5tYXhTdWJTdGVwcywgZml4ZWRUaW1lU3RlcCApOw0KCQlyZXBvcnRWZWhpY2xlcygpOw0KCQlyZXBvcnRDb2xsaXNpb25zKCk7DQoJCXJlcG9ydENvbnN0cmFpbnRzKCk7DQoJCXJlcG9ydFdvcmxkKCk7DQoJCXdvcmxkLmNsZWFyRm9yY2VzKCk7DQoJCWxhc3Rfc2ltdWxhdGlvbl9kdXJhdGlvbiA9ICggRGF0ZS5ub3coKSAtIGxhc3Rfc2ltdWxhdGlvbl9kdXJhdGlvbiApIC8gMTAwMDsNCgkJDQoJCWxhc3Rfc2ltdWxhdGlvbl90aW1lID0gRGF0ZS5ub3coKTsNCgl9DQp9Ow0KDQoNCi8vIENvbnN0cmFpbnQgZnVuY3Rpb25zDQpwdWJsaWNfZnVuY3Rpb25zLmhpbmdlX3NldExpbWl0cyA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdLnNldExpbWl0KCBwYXJhbXMubG93LCBwYXJhbXMuaGlnaCwgMCwgcGFyYW1zLmJpYXNfZmFjdG9yLCBwYXJhbXMucmVsYXhhdGlvbl9mYWN0b3IgKTsNCn07DQpwdWJsaWNfZnVuY3Rpb25zLmhpbmdlX2VuYWJsZUFuZ3VsYXJNb3RvciA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5lbmFibGVBbmd1bGFyTW90b3IoIHRydWUsIHBhcmFtcy52ZWxvY2l0eSwgcGFyYW1zLmFjY2VsZXJhdGlvbiApOw0KCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QSgpLmFjdGl2YXRlKCk7DQoJaWYgKCBjb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKSApIHsNCgkJY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkuYWN0aXZhdGUoKTsNCgl9DQp9Ow0KcHVibGljX2Z1bmN0aW9ucy5oaW5nZV9kaXNhYmxlTW90b3IgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCV9jb25zdHJhaW50c1sgcGFyYW1zLmNvbnN0cmFpbnQgXS5lbmFibGVNb3RvciggZmFsc2UgKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQoNCnB1YmxpY19mdW5jdGlvbnMuc2xpZGVyX3NldExpbWl0cyA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRMb3dlckxpbkxpbWl0KCBwYXJhbXMubGluX2xvd2VyIHx8IDAgKTsNCgljb25zdHJhaW50LnNldFVwcGVyTGluTGltaXQoIHBhcmFtcy5saW5fdXBwZXIgfHwgMCApOw0KCQ0KCWNvbnN0cmFpbnQuc2V0TG93ZXJBbmdMaW1pdCggcGFyYW1zLmFuZ19sb3dlciB8fCAwICk7DQoJY29uc3RyYWludC5zZXRVcHBlckFuZ0xpbWl0KCBwYXJhbXMuYW5nX3VwcGVyIHx8IDAgKTsNCn07DQpwdWJsaWNfZnVuY3Rpb25zLnNsaWRlcl9zZXRSZXN0aXR1dGlvbiA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRTb2Z0bmVzc0xpbUxpbiggcGFyYW1zLmxpbmVhciB8fCAwICk7DQoJY29uc3RyYWludC5zZXRTb2Z0bmVzc0xpbUFuZyggcGFyYW1zLmFuZ3VsYXIgfHwgMCApOw0KfTsNCnB1YmxpY19mdW5jdGlvbnMuc2xpZGVyX2VuYWJsZUxpbmVhck1vdG9yID0gZnVuY3Rpb24oIHBhcmFtcyApIHsNCgl2YXIgY29uc3RyYWludCA9IF9jb25zdHJhaW50c1sgcGFyYW1zLmNvbnN0cmFpbnQgXTsNCgljb25zdHJhaW50LnNldFRhcmdldExpbk1vdG9yVmVsb2NpdHkoIHBhcmFtcy52ZWxvY2l0eSApOw0KCWNvbnN0cmFpbnQuc2V0TWF4TGluTW90b3JGb3JjZSggcGFyYW1zLmFjY2VsZXJhdGlvbiApOw0KCWNvbnN0cmFpbnQuc2V0UG93ZXJlZExpbk1vdG9yKCB0cnVlICk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QiApIHsNCgkJY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkuYWN0aXZhdGUoKTsNCgl9DQp9Ow0KcHVibGljX2Z1bmN0aW9ucy5zbGlkZXJfZGlzYWJsZUxpbmVhck1vdG9yID0gZnVuY3Rpb24oIHBhcmFtcyApIHsNCgl2YXIgY29uc3RyYWludCA9IF9jb25zdHJhaW50c1sgcGFyYW1zLmNvbnN0cmFpbnQgXTsNCgljb25zdHJhaW50LnNldFBvd2VyZWRMaW5Nb3RvciggZmFsc2UgKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLnNsaWRlcl9lbmFibGVBbmd1bGFyTW90b3IgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdOw0KCWNvbnN0cmFpbnQuc2V0VGFyZ2V0QW5nTW90b3JWZWxvY2l0eSggcGFyYW1zLnZlbG9jaXR5ICk7DQoJY29uc3RyYWludC5zZXRNYXhBbmdNb3RvckZvcmNlKCBwYXJhbXMuYWNjZWxlcmF0aW9uICk7DQoJY29uc3RyYWludC5zZXRQb3dlcmVkQW5nTW90b3IoIHRydWUgKTsNCgljb25zdHJhaW50LmdldFJpZ2lkQm9keUEoKS5hY3RpdmF0ZSgpOw0KCWlmICggY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkgKSB7DQoJCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpLmFjdGl2YXRlKCk7DQoJfQ0KfTsNCnB1YmxpY19mdW5jdGlvbnMuc2xpZGVyX2Rpc2FibGVBbmd1bGFyTW90b3IgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdOw0KCWNvbnN0cmFpbnQuc2V0UG93ZXJlZEFuZ01vdG9yKCBmYWxzZSApOw0KCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QSgpLmFjdGl2YXRlKCk7DQoJaWYgKCBjb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKSApIHsNCgkJY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkuYWN0aXZhdGUoKTsNCgl9DQp9Ow0KDQpwdWJsaWNfZnVuY3Rpb25zLmNvbmV0d2lzdF9zZXRMaW1pdCA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdLnNldExpbWl0KCBwYXJhbXMueiwgcGFyYW1zLnksIHBhcmFtcy54ICk7IC8vIFpZWCBvcmRlcg0KfTsNCnB1YmxpY19mdW5jdGlvbnMuY29uZXR3aXN0X2VuYWJsZU1vdG9yID0gZnVuY3Rpb24oIHBhcmFtcyApIHsNCgl2YXIgY29uc3RyYWludCA9IF9jb25zdHJhaW50c1sgcGFyYW1zLmNvbnN0cmFpbnQgXTsNCgljb25zdHJhaW50LmVuYWJsZU1vdG9yKCB0cnVlICk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCgljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KfTsNCnB1YmxpY19mdW5jdGlvbnMuY29uZXR3aXN0X3NldE1heE1vdG9ySW1wdWxzZSA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRNYXhNb3RvckltcHVsc2UoIHBhcmFtcy5tYXhfaW1wdWxzZSApOw0KCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QSgpLmFjdGl2YXRlKCk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkuYWN0aXZhdGUoKTsNCn07DQpwdWJsaWNfZnVuY3Rpb25zLmNvbmV0d2lzdF9zZXRNb3RvclRhcmdldCA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRNb3RvclRhcmdldChuZXcgQW1tby5idFF1YXRlcm5pb24oIHBhcmFtcy54LCBwYXJhbXMueSwgcGFyYW1zLnosIHBhcmFtcy53ICkpOw0KCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QSgpLmFjdGl2YXRlKCk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkuYWN0aXZhdGUoKTsNCn07DQpwdWJsaWNfZnVuY3Rpb25zLmNvbmV0d2lzdF9kaXNhYmxlTW90b3IgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdOw0KCWNvbnN0cmFpbnQuZW5hYmxlTW90b3IoIGZhbHNlICk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCgljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KfTsNCg0KcHVibGljX2Z1bmN0aW9ucy5kb2Zfc2V0TGluZWFyTG93ZXJMaW1pdCA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRMaW5lYXJMb3dlckxpbWl0KG5ldyBBbW1vLmJ0VmVjdG9yMyggcGFyYW1zLngsIHBhcmFtcy55LCBwYXJhbXMueiApKTsNCgljb25zdHJhaW50LmdldFJpZ2lkQm9keUEoKS5hY3RpdmF0ZSgpOw0KCWlmICggY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkgKSB7DQoJCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpLmFjdGl2YXRlKCk7DQoJfQ0KfTsNCnB1YmxpY19mdW5jdGlvbnMuZG9mX3NldExpbmVhclVwcGVyTGltaXQgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdOw0KCWNvbnN0cmFpbnQuc2V0TGluZWFyVXBwZXJMaW1pdChuZXcgQW1tby5idFZlY3RvcjMoIHBhcmFtcy54LCBwYXJhbXMueSwgcGFyYW1zLnogKSk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLmRvZl9zZXRBbmd1bGFyTG93ZXJMaW1pdCA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRBbmd1bGFyTG93ZXJMaW1pdChuZXcgQW1tby5idFZlY3RvcjMoIHBhcmFtcy54LCBwYXJhbXMueSwgcGFyYW1zLnogKSk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLmRvZl9zZXRBbmd1bGFyVXBwZXJMaW1pdCA9IGZ1bmN0aW9uKCBwYXJhbXMgKSB7DQoJdmFyIGNvbnN0cmFpbnQgPSBfY29uc3RyYWludHNbIHBhcmFtcy5jb25zdHJhaW50IF07DQoJY29uc3RyYWludC5zZXRBbmd1bGFyVXBwZXJMaW1pdChuZXcgQW1tby5idFZlY3RvcjMoIHBhcmFtcy54LCBwYXJhbXMueSwgcGFyYW1zLnogKSk7DQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLmRvZl9lbmFibGVBbmd1bGFyTW90b3IgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdOw0KCQ0KCXZhciBtb3RvciA9IGNvbnN0cmFpbnQuZ2V0Um90YXRpb25hbExpbWl0TW90b3IoIHBhcmFtcy53aGljaCApOw0KCW1vdG9yLnNldF9tX2VuYWJsZU1vdG9yKCB0cnVlICk7DQoJDQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLmRvZl9jb25maWd1cmVBbmd1bGFyTW90b3IgPSBmdW5jdGlvbiggcGFyYW1zICkgew0KCXZhciBjb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzWyBwYXJhbXMuY29uc3RyYWludCBdOw0KCQ0KCXZhciBtb3RvciA9IGNvbnN0cmFpbnQuZ2V0Um90YXRpb25hbExpbWl0TW90b3IoIHBhcmFtcy53aGljaCApOw0KCQ0KCW1vdG9yLnNldF9tX2xvTGltaXQoIHBhcmFtcy5sb3dfYW5nbGUgKTsNCgltb3Rvci5zZXRfbV9oaUxpbWl0KCBwYXJhbXMuaGlnaF9hbmdsZSApOw0KCW1vdG9yLnNldF9tX3RhcmdldFZlbG9jaXR5KCBwYXJhbXMudmVsb2NpdHkgKTsNCgltb3Rvci5zZXRfbV9tYXhNb3RvckZvcmNlKCBwYXJhbXMubWF4X2ZvcmNlICk7DQoJDQoJY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCkuYWN0aXZhdGUoKTsNCglpZiAoIGNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpICkgew0KCQljb25zdHJhaW50LmdldFJpZ2lkQm9keUIoKS5hY3RpdmF0ZSgpOw0KCX0NCn07DQpwdWJsaWNfZnVuY3Rpb25zLmRvZl9kaXNhYmxlQW5ndWxhck1vdG9yID0gZnVuY3Rpb24oIHBhcmFtcyApIHsNCgl2YXIgY29uc3RyYWludCA9IF9jb25zdHJhaW50c1sgcGFyYW1zLmNvbnN0cmFpbnQgXTsNCgkNCgl2YXIgbW90b3IgPSBjb25zdHJhaW50LmdldFJvdGF0aW9uYWxMaW1pdE1vdG9yKCBwYXJhbXMud2hpY2ggKTsNCgltb3Rvci5zZXRfbV9lbmFibGVNb3RvciggZmFsc2UgKTsNCgkNCgljb25zdHJhaW50LmdldFJpZ2lkQm9keUEoKS5hY3RpdmF0ZSgpOw0KCWlmICggY29uc3RyYWludC5nZXRSaWdpZEJvZHlCKCkgKSB7DQoJCWNvbnN0cmFpbnQuZ2V0UmlnaWRCb2R5QigpLmFjdGl2YXRlKCk7DQoJfQ0KfTsNCg0KcmVwb3J0V29ybGQgPSBmdW5jdGlvbigpIHsNCgl2YXIgaW5kZXgsIG9iamVjdCwNCgkJdHJhbnNmb3JtID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm0oKSwgb3JpZ2luLCByb3RhdGlvbiwNCgkJb2Zmc2V0ID0gMCwNCgkJaSA9IDA7DQoJDQoJaWYgKCBzZWxmLndlYmtpdFBvc3RNZXNzYWdlICkgew0KCQlpZiAoIHdvcmxkcmVwb3J0Lmxlbmd0aCA8IDIgKyBfbnVtX29iamVjdHMgKiBXT1JMRFJFUE9SVF9JVEVNU0laRSApIHsNCgkJCXdvcmxkcmVwb3J0ID0gbmV3IEZsb2F0MzJBcnJheSgNCgkJCQkyICsgLy8gbWVzc2FnZSBpZCAmICMgb2JqZWN0cyBpbiByZXBvcnQNCgkJCQkoIE1hdGguY2VpbCggX251bV9vYmplY3RzIC8gUkVQT1JUX0NIVU5LU0laRSApICogUkVQT1JUX0NIVU5LU0laRSApICogV09STERSRVBPUlRfSVRFTVNJWkUgLy8gIyBvZiB2YWx1ZXMgbmVlZGVkICogaXRlbSBzaXplDQoJCQkpOw0KCQkJd29ybGRyZXBvcnRbMF0gPSBNRVNTQUdFX1RZUEVTLldPUkxEUkVQT1JUOw0KCQl9DQoJfQ0KCQ0KCXdvcmxkcmVwb3J0WzFdID0gX251bV9vYmplY3RzOyAvLyByZWNvcmQgaG93IG1hbnkgb2JqZWN0cyB3ZSdyZSByZXBvcnRpbmcgb24NCg0KCS8vZm9yICggaSA9IDA7IGkgPCB3b3JsZHJlcG9ydFsxXTsgaSsrICkgew0KCWZvciAoIGluZGV4IGluIF9vYmplY3RzICkgew0KCQlpZiAoIF9vYmplY3RzLmhhc093blByb3BlcnR5KCBpbmRleCApICkgew0KCQkJb2JqZWN0ID0gX29iamVjdHNbaW5kZXhdOw0KCQkJDQoJCQkvLyAjVE9ETzogd2UgY2FuJ3QgdXNlIGNlbnRlciBvZiBtYXNzIHRyYW5zZm9ybSB3aGVuIGNlbnRlciBvZiBtYXNzIGNhbiBjaGFuZ2UsDQoJCQkvLyAgICAgICAgYnV0IGdldE1vdGlvblN0YXRlKCkuZ2V0V29ybGRUcmFuc2Zvcm0oKSBzY3Jld3MgdXAgb24gb2JqZWN0cyB0aGF0IGhhdmUgYmVlbiBtb3ZlZA0KCQkJLy9vYmplY3QuZ2V0TW90aW9uU3RhdGUoKS5nZXRXb3JsZFRyYW5zZm9ybSggdHJhbnNmb3JtICk7DQoJCQl0cmFuc2Zvcm0gPSBvYmplY3QuZ2V0Q2VudGVyT2ZNYXNzVHJhbnNmb3JtKCk7DQoJCQkNCgkJCW9yaWdpbiA9IHRyYW5zZm9ybS5nZXRPcmlnaW4oKTsNCgkJCXJvdGF0aW9uID0gdHJhbnNmb3JtLmdldFJvdGF0aW9uKCk7DQoJCQkNCgkJCS8vIGFkZCB2YWx1ZXMgdG8gcmVwb3J0DQoJCQlvZmZzZXQgPSAyICsgKGkrKykgKiBXT1JMRFJFUE9SVF9JVEVNU0laRTsNCgkJCQ0KCQkJd29ybGRyZXBvcnRbIG9mZnNldCBdID0gb2JqZWN0LmlkOw0KCQkJDQoJCQl3b3JsZHJlcG9ydFsgb2Zmc2V0ICsgMSBdID0gb3JpZ2luLngoKTsNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyAyIF0gPSBvcmlnaW4ueSgpOw0KCQkJd29ybGRyZXBvcnRbIG9mZnNldCArIDMgXSA9IG9yaWdpbi56KCk7DQoJCQkNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyA0IF0gPSByb3RhdGlvbi54KCk7DQoJCQl3b3JsZHJlcG9ydFsgb2Zmc2V0ICsgNSBdID0gcm90YXRpb24ueSgpOw0KCQkJd29ybGRyZXBvcnRbIG9mZnNldCArIDYgXSA9IHJvdGF0aW9uLnooKTsNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyA3IF0gPSByb3RhdGlvbi53KCk7DQoJCQkNCgkJCV92ZWN0b3IgPSBvYmplY3QuZ2V0TGluZWFyVmVsb2NpdHkoKTsNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyA4IF0gPSBfdmVjdG9yLngoKTsNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyA5IF0gPSBfdmVjdG9yLnkoKTsNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyAxMCBdID0gX3ZlY3Rvci56KCk7DQoJCQkNCgkJCV92ZWN0b3IgPSBvYmplY3QuZ2V0QW5ndWxhclZlbG9jaXR5KCk7DQoJCQl3b3JsZHJlcG9ydFsgb2Zmc2V0ICsgMTEgXSA9IF92ZWN0b3IueCgpOw0KCQkJd29ybGRyZXBvcnRbIG9mZnNldCArIDEyIF0gPSBfdmVjdG9yLnkoKTsNCgkJCXdvcmxkcmVwb3J0WyBvZmZzZXQgKyAxMyBdID0gX3ZlY3Rvci56KCk7DQoJCX0NCgl9DQoJDQoJdHJhbnNmZXJhYmxlTWVzc2FnZSggd29ybGRyZXBvcnQsIFt3b3JsZHJlcG9ydC5idWZmZXJdICk7DQp9Ow0KDQpyZXBvcnRDb2xsaXNpb25zID0gZnVuY3Rpb24oKSB7DQoJdmFyIGksIG9mZnNldCwNCgkJZHAgPSB3b3JsZC5nZXREaXNwYXRjaGVyKCksDQoJCW51bSA9IGRwLmdldE51bU1hbmlmb2xkcygpLA0KCQltYW5pZm9sZCwgbnVtX2NvbnRhY3RzLCBqLCBwdCwNCgkJX2NvbGxpZGVkID0gZmFsc2U7DQoJDQoJaWYgKCBzZWxmLndlYmtpdFBvc3RNZXNzYWdlICkgew0KCQlpZiAoIGNvbGxpc2lvbnJlcG9ydC5sZW5ndGggPCAyICsgbnVtICogQ09MTElTSU9OUkVQT1JUX0lURU1TSVpFICkgew0KCQkJY29sbGlzaW9ucmVwb3J0ID0gbmV3IEZsb2F0MzJBcnJheSgNCgkJCQkyICsgLy8gbWVzc2FnZSBpZCAmICMgb2JqZWN0cyBpbiByZXBvcnQNCgkJCQkoIE1hdGguY2VpbCggX251bV9vYmplY3RzIC8gUkVQT1JUX0NIVU5LU0laRSApICogUkVQT1JUX0NIVU5LU0laRSApICogQ09MTElTSU9OUkVQT1JUX0lURU1TSVpFIC8vICMgb2YgdmFsdWVzIG5lZWRlZCAqIGl0ZW0gc2l6ZQ0KCQkJKTsNCgkJCWNvbGxpc2lvbnJlcG9ydFswXSA9IE1FU1NBR0VfVFlQRVMuQ09MTElTSU9OUkVQT1JUOw0KCQl9DQoJfQ0KCQ0KCWNvbGxpc2lvbnJlcG9ydFsxXSA9IDA7IC8vIGhvdyBtYW55IGNvbGxpc2lvbnMgd2UncmUgcmVwb3J0aW5nIG9uDQoJDQoJZm9yICggaSA9IDA7IGkgPCBudW07IGkrKyApIHsNCgkJbWFuaWZvbGQgPSBkcC5nZXRNYW5pZm9sZEJ5SW5kZXhJbnRlcm5hbCggaSApOw0KCQkNCgkJbnVtX2NvbnRhY3RzID0gbWFuaWZvbGQuZ2V0TnVtQ29udGFjdHMoKTsNCgkJaWYgKCBudW1fY29udGFjdHMgPT09IDAgKSB7DQoJCQljb250aW51ZTsNCgkJfQ0KCQkNCgkJZm9yICggaiA9IDA7IGogPCBudW1fY29udGFjdHM7IGorKyApIHsNCgkJCXB0ID0gbWFuaWZvbGQuZ2V0Q29udGFjdFBvaW50KCBqICk7DQoJCQkvL2lmICggcHQuZ2V0RGlzdGFuY2UoKSA8IDAgKSB7DQoJCQkJb2Zmc2V0ID0gMiArIChjb2xsaXNpb25yZXBvcnRbMV0rKykgKiBDT0xMSVNJT05SRVBPUlRfSVRFTVNJWkU7DQoJCQkJY29sbGlzaW9ucmVwb3J0WyBvZmZzZXQgXSA9IF9vYmplY3RzX2FtbW9bIG1hbmlmb2xkLmdldEJvZHkwKCkgXTsNCgkJCQljb2xsaXNpb25yZXBvcnRbIG9mZnNldCArIDEgXSA9IF9vYmplY3RzX2FtbW9bIG1hbmlmb2xkLmdldEJvZHkxKCkgXTsNCgkJCQlicmVhazsNCgkJCS8vfQ0KCQl9DQoJfQ0KCQ0KCXRyYW5zZmVyYWJsZU1lc3NhZ2UoIGNvbGxpc2lvbnJlcG9ydCwgW2NvbGxpc2lvbnJlcG9ydC5idWZmZXJdICk7DQp9Ow0KDQpyZXBvcnRWZWhpY2xlcyA9IGZ1bmN0aW9uKCkgew0KCXZhciBpbmRleCwgdmVoaWNsZSwNCgkJdHJhbnNmb3JtID0gbmV3IEFtbW8uYnRUcmFuc2Zvcm0sIG9yaWdpbiwgcm90YXRpb24sDQoJCW9mZnNldCA9IDAsDQoJCWkgPSAwLCBqID0gMDsNCglmb3IgKCBpbmRleCBpbiBfdmVoaWNsZXMgKSB7DQoJCWlmICggX3ZlaGljbGVzLmhhc093blByb3BlcnR5KCBpbmRleCApICkgew0KCQkJdmVoaWNsZSA9IF92ZWhpY2xlc1tpbmRleF07DQoNCgkJCWZvciAoIGogPSAwOyBqIDwgdmVoaWNsZS5nZXROdW1XaGVlbHMoKTsgaisrICkgew0KDQoJCQkJLy92ZWhpY2xlLnVwZGF0ZVdoZWVsVHJhbnNmb3JtKCBqLCB0cnVlICk7DQoNCgkJCQkvL3RyYW5zZm9ybSA9IHZlaGljbGUuZ2V0V2hlZWxUcmFuc2Zvcm1XUyggaiApOw0KCQkJCXRyYW5zZm9ybSA9IHZlaGljbGUuZ2V0V2hlZWxJbmZvKCBqICkuZ2V0X21fd29ybGRUcmFuc2Zvcm0oKTsNCg0KCQkJCW9yaWdpbiA9IHRyYW5zZm9ybS5nZXRPcmlnaW4oKTsNCgkJCQlyb3RhdGlvbiA9IHRyYW5zZm9ybS5nZXRSb3RhdGlvbigpOw0KDQoJCQkJLy8gYWRkIHZhbHVlcyB0byByZXBvcnQNCgkJCQlvZmZzZXQgPSAxICsgKGkrKykgKiBWRUhJQ0xFUkVQT1JUX0lURU1TSVpFOw0KDQoJCQkJdmVoaWNsZXJlcG9ydFsgb2Zmc2V0IF0gPSBpbmRleDsNCgkJCQl2ZWhpY2xlcmVwb3J0WyBvZmZzZXQgKyAxIF0gPSBqOw0KDQoJCQkJdmVoaWNsZXJlcG9ydFsgb2Zmc2V0ICsgMiBdID0gb3JpZ2luLngoKTsNCgkJCQl2ZWhpY2xlcmVwb3J0WyBvZmZzZXQgKyAzIF0gPSBvcmlnaW4ueSgpOw0KCQkJCXZlaGljbGVyZXBvcnRbIG9mZnNldCArIDQgXSA9IG9yaWdpbi56KCk7DQoNCgkJCQl2ZWhpY2xlcmVwb3J0WyBvZmZzZXQgKyA1IF0gPSByb3RhdGlvbi54KCk7DQoJCQkJdmVoaWNsZXJlcG9ydFsgb2Zmc2V0ICsgNiBdID0gcm90YXRpb24ueSgpOw0KCQkJCXZlaGljbGVyZXBvcnRbIG9mZnNldCArIDcgXSA9IHJvdGF0aW9uLnooKTsNCgkJCQl2ZWhpY2xlcmVwb3J0WyBvZmZzZXQgKyA4IF0gPSByb3RhdGlvbi53KCk7DQoNCgkJCX0NCg0KCQl9DQoJfQ0KDQoJaWYgKCBqICE9PSAwICkgew0KCQl0cmFuc2ZlcmFibGVNZXNzYWdlKCB2ZWhpY2xlcmVwb3J0LCBbdmVoaWNsZXJlcG9ydC5idWZmZXJdICk7DQoJfQ0KfTsNCg0KcmVwb3J0Q29uc3RyYWludHMgPSBmdW5jdGlvbigpIHsNCgl2YXIgaW5kZXgsIGNvbnN0cmFpbnQsDQoJCW9mZnNldF9ib2R5LA0KCQl0cmFuc2Zvcm0gPSBuZXcgQW1tby5idFRyYW5zZm9ybSwgb3JpZ2luLA0KCQlvZmZzZXQgPSAwLA0KCQlpID0gMDsNCg0KCWZvciAoIGluZGV4IGluIF9jb25zdHJhaW50cyApIHsNCgkJaWYgKCBfY29uc3RyYWludHMuaGFzT3duUHJvcGVydHkoIGluZGV4ICkgKSB7DQoJCQljb25zdHJhaW50ID0gX2NvbnN0cmFpbnRzW2luZGV4XTsNCgkJCW9mZnNldF9ib2R5ID0gY29uc3RyYWludC5nZXRSaWdpZEJvZHlBKCk7DQoJCQl0cmFuc2Zvcm0gPSBjb25zdHJhaW50LmdldEZyYW1lT2Zmc2V0QSgpOw0KCQkJb3JpZ2luID0gdHJhbnNmb3JtLmdldE9yaWdpbigpOw0KDQoJCQkvLyBhZGQgdmFsdWVzIHRvIHJlcG9ydA0KCQkJb2Zmc2V0ID0gMSArIChpKyspICogQ09OU1RSQUlOVFJFUE9SVF9JVEVNU0laRTsNCg0KCQkJY29uc3RyYWludHJlcG9ydFsgb2Zmc2V0IF0gPSBpbmRleDsNCgkJCWNvbnN0cmFpbnRyZXBvcnRbIG9mZnNldCArIDEgXSA9IG9mZnNldF9ib2R5LmlkOw0KCQkJY29uc3RyYWludHJlcG9ydFsgb2Zmc2V0ICsgMiBdID0gb3JpZ2luLmdldFgoKTsNCgkJCWNvbnN0cmFpbnRyZXBvcnRbIG9mZnNldCArIDMgXSA9IG9yaWdpbi5nZXRZKCk7DQoJCQljb25zdHJhaW50cmVwb3J0WyBvZmZzZXQgKyA0IF0gPSBvcmlnaW4uZ2V0WigpOw0KCQkJY29uc3RyYWludHJlcG9ydFsgb2Zmc2V0ICsgNSBdID0gY29uc3RyYWludC5nZXRBcHBsaWVkSW1wdWxzZSgpOw0KCQl9DQoJfQ0KDQoJaWYgKCBpICE9PSAwICkgew0KCQl0cmFuc2ZlcmFibGVNZXNzYWdlKCBjb25zdHJhaW50cmVwb3J0LCBbY29uc3RyYWludHJlcG9ydC5idWZmZXJdICk7DQoJfQ0KfTsNCg0Kc2VsZi5vbm1lc3NhZ2UgPSBmdW5jdGlvbiggZXZlbnQgKSB7DQoJDQoJaWYgKCBldmVudC5kYXRhIGluc3RhbmNlb2YgRmxvYXQzMkFycmF5ICkgew0KCQkvLyB0cmFuc2ZlcmFibGUgb2JqZWN0DQoJCQ0KCQlzd2l0Y2ggKCBldmVudC5kYXRhWzBdICkgew0KCQkJY2FzZSBNRVNTQUdFX1RZUEVTLldPUkxEUkVQT1JUOg0KCQkJCXdvcmxkcmVwb3J0ID0gZXZlbnQuZGF0YTsNCgkJCQlicmVhazsNCg0KCQkJY2FzZSBNRVNTQUdFX1RZUEVTLkNPTExJU0lPTlJFUE9SVDoNCgkJCQljb2xsaXNpb25yZXBvcnQgPSBldmVudC5kYXRhOw0KCQkJCWJyZWFrOw0KDQoJCQljYXNlIE1FU1NBR0VfVFlQRVMuVkVISUNMRVJFUE9SVDoNCgkJCQl2ZWhpY2xlcmVwb3J0ID0gZXZlbnQuZGF0YTsNCgkJCQlicmVhazsNCg0KCQkJY2FzZSBNRVNTQUdFX1RZUEVTLkNPTlNUUkFJTlRSRVBPUlQ6DQoJCQkJY29uc3RyYWludHJlcG9ydCA9IGV2ZW50LmRhdGE7DQoJCQkJYnJlYWs7DQoJCX0NCgkJDQoJCXJldHVybjsNCgl9DQoJDQoJaWYgKCBldmVudC5kYXRhLmNtZCAmJiBwdWJsaWNfZnVuY3Rpb25zW2V2ZW50LmRhdGEuY21kXSApIHsNCgkJLy9pZiAoIGV2ZW50LmRhdGEucGFyYW1zLmlkICE9PSB1bmRlZmluZWQgJiYgX29iamVjdHNbZXZlbnQuZGF0YS5wYXJhbXMuaWRdID09PSB1bmRlZmluZWQgJiYgZXZlbnQuZGF0YS5jbWQgIT09ICdhZGRPYmplY3QnICYmIGV2ZW50LmRhdGEuY21kICE9PSAncmVnaXN0ZXJNYXRlcmlhbCcgKSByZXR1cm47DQoJCXB1YmxpY19mdW5jdGlvbnNbZXZlbnQuZGF0YS5jbWRdKCBldmVudC5kYXRhLnBhcmFtcyApOw0KCX0NCgkNCn07";
		Physijs.scripts.ammo = base+'ammo.js';
		var numberOfDomElements = 0;
    function get3DPageObjects() {
      var objects = [];
      function recursivelyAddElementToObjects(e, zlevel) {
				numberOfDomElements++;
        var offset = e.offset();
        objects.push({
          x: offset.left, 
          y: offset.top, 
          z: 10+(10*zlevel), 
          width: e.outerWidth(), 
          height: e.outerHeight(), 
          depth: 10
        });
				//if(numberOfDomElements<120) //a limiter for the number of dom elements
        e.children().each(function() {
          recursivelyAddElementToObjects($(this), zlevel + 1);
        });
      };

      recursivelyAddElementToObjects($('body'), 1);
      return objects;
    }

    $(function() {
      var cameraVector, scene, renderer, controls, input;
      var clock = new THREE.Clock();
			
			var MOVESPEED = 5000,
					LOOKSPEED = 0.1,
					WIDTH = window.innerWidth,
					HEIGHT = window.innerHeight,
					CAMERADISTANCE = 100,
					ROTATESPEED = Math.PI / 32,
					YAXIS = new THREE.Vector3(0, 1, 0);
					
			cameraVector = new THREE.Vector3(1, 0, 0);

      // adds a 3D DOM object to the scene, handling conversions between coordinate systems.
      function addObject(o) {
          var geometry = new THREE.CubeGeometry(o.width,o.height,o.depth);
          var material = new THREE.MeshBasicMaterial( { color: 0xff00ff*Math.random(), wireframe: false } );

          var mesh = new THREE.Mesh( geometry, material );
          mesh.position.x = o.x+(o.width/2);
          mesh.position.y = (-1*o.y)+(o.height/-2);
          mesh.position.z = o.z;
          scene.add(mesh);
      }

      // returns a cropped copy of the given image in callback
      function dataURLWithCroppedImage(srcImage, x, y, width, height, callback) {
        var canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(srcImage, x, y, width, height, 0, 0, width, height);
        
        return canvas.toDataURL('image/png');
      }

      function threejs_init() {	
        scene = new Physijs.Scene();
				scene.setGravity(new THREE.Vector3( 0, -300, 0 ));
				scene.addEventListener(
					'update',
					function() {
						playerControls();					
						scene.simulate( undefined, 1 );
						physics_stats.update();
					}
				);
				
				//camera
        camera = new THREE.PerspectiveCamera( 75, WIDTH / HEIGHT, 1, 10000 );
				camera.position.y = 500;
        /*controls = new THREE.FirstPersonControls(camera);
        controls.movementSpeed = MOVESPEED;
        controls.lookSpeed = LOOKSPEED;
				controls.noFly = true;*/
				scene.add(camera);
				
				//Random Block
				for(var i = 0; i < 10; i++)
				//createBox();
				
				//Player Block
				var player_material  = new THREE.MeshBasicMaterial({color: 0xcdecde});
				var player_material2 = new THREE.MeshBasicMaterial({color: 0x555555});
				var materials = [player_material2,player_material,player_material,player_material,player_material,player_material]
				var player_physijs_material = Physijs.createMaterial(
					player_material,
					.2, // medium friction
					.3 // low restitution
				);
				player = new Physijs.BoxMesh (
					new THREE.CubeGeometry(10, 10, 10),
					player_physijs_material, 5
				);
				player.position.set(400, 500, 300);				
				player.castShadow = true;
				//box.addEventListener( 'collision', handleCollision );
				//box.addEventListener( 'ready', spawnBox );
				player.addEventListener( 'collision', function( other_object, relative_velocity, relative_rotation ) {
					//console.log(other_object, relative_velocity, relative_rotation);
					// `this` has collided with `other_object` with an impact speed of `relative_velocity` and a rotational force of `relative_rotation`
				});
				scene.add( player );
				
				// Input commands
				player.FORWARDS = "forwards";
				player.BACKWARDS = "backwards"
				player.LEFT = "left";
				player.RIGHT = "right";
				player.FIRE = "fire";
				player.SUICIDE = "suicide";
				player.WALK = "walk";
				player.DAMAGE = "damage";
				player.MAXSPEED = 50;
				player.ROTATIONSPEED = 5;
				
				// Light
				light = new THREE.DirectionalLight( 0xFFFFFF );
				light.position.set( 20, 40, -15 );
				light.target.position.copy( scene.position );
				light.castShadow = true;
				light.shadowCameraLeft = -60;
				light.shadowCameraTop = -60;
				light.shadowCameraRight = 60;
				light.shadowCameraBottom = 60;
				light.shadowCameraNear = 20;
				light.shadowCameraFar = 200;
				light.shadowBias = -.0001
				light.shadowMapWidth = light.shadowMapHeight = 2048;
				light.shadowDarkness = .7;
				scene.add( light );
				
				// Ground
				/*ground_material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) }),
					.8, // high friction
					.3 // low restitution
				);
				ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
				ground_material.map.repeat.set( 3, 3 );
				
				ground = new Physijs.BoxMesh(
					new THREE.CubeGeometry(100, 1, 100),
					ground_material,
					0 // mass
				);
				ground.receiveShadow = true;
				scene.add( ground );*/
				
				// 3D DOM
				//add dom elements to the parent mesh, then add the parent at the end.
				var parent = new Physijs.BoxMesh( new THREE.CubeGeometry( 1, 1, 1 ), new THREE.MeshBasicMaterial({ color: 0x888888 }), 0 );
        var objects = get3DPageObjects();

        html2canvas( [ $('body')[0] ], {
          onrendered: function( canvas ) {
            var bodyImg = new Image();
            bodyImg.onload = function() {
              // add each 3D DOM object to the scene, handling conversions between coordinate systems.
              function addObjectAtIndex(i) {
                var o = objects[i];

                var gray_material = new THREE.MeshBasicMaterial({color: 0x555555});
                var cropped_url = dataURLWithCroppedImage(bodyImg, o.x, o.y, o.width, o.height);
              
                var croppedImage = new Image();
                croppedImage.src = cropped_url;
                croppedImage.tex = new THREE.Texture(croppedImage);
                croppedImage.tex.needsUpdate = true;
                croppedImage.onload = function() {
                  this.tex.needsUpdate = true;
                }

                var image_material = new THREE.MeshBasicMaterial({color: 0xffffff, map: croppedImage.tex});

                var materials = [gray_material,gray_material,image_material,gray_material,gray_material,gray_material]
                var geometry = new THREE.CubeGeometry(o.width,o.depth,o.height,1,1,1,materials);

                var mesh = new Physijs.BoxMesh( geometry, new THREE.MeshFaceMaterial() );
                mesh.position.x = o.x+(o.width/2);
                mesh.position.y = o.z;
                mesh.position.z = -((-1*o.y)+(o.height/-2)); //switching y and z axis
                parent.add(mesh);
              
              }

              for(var i in objects)
                addObjectAtIndex(i);
							scene.add(parent);

            }
            bodyImg.src = canvas.toDataURL("image/png");

            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize( WIDTH, HEIGHT );

            document.body.appendChild( renderer.domElement );
            $(renderer.domElement).css('position','fixed').css('left','0').css('top','0').css('background-color','#333');
						
						//stats box
						render_stats = new Stats();
						render_stats.domElement.style.position = 'absolute';
						render_stats.domElement.style.top = '0px';
						render_stats.domElement.style.zIndex = 100;
						document.getElementsByTagName('body')[0].appendChild( render_stats.domElement );
						
						physics_stats = new Stats();
						physics_stats.domElement.style.position = 'absolute';
						physics_stats.domElement.style.top = '50px';
						physics_stats.domElement.style.zIndex = 100;
						document.getElementsByTagName('body')[0].appendChild( physics_stats.domElement );
						
            threejs_animate();

          }
        });
				start(); //initialize multiplayer functionality
      }

			//Create a small wooden box near the position (400, 500, 300)
			createBox = function() {
				var box, material;
				var box_geometry = new THREE.CubeGeometry( 4, 4, 4 ),
				
				material = Physijs.createMaterial(
					new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/plywood.jpg' ) }),
					.6, // medium friction
					.3 // low restitution
				);
				material.map.wrapS = material.map.wrapT = THREE.RepeatWrapping;
				material.map.repeat.set( .5, .5 );
				
				//material = new THREE.MeshLambertMaterial({ map: THREE.ImageUtils.loadTexture( 'images/rocks.jpg' ) });
				
				box = new Physijs.BoxMesh(
					box_geometry,
					material
				);
				//box.collisions = 0;
				
				box.position.set(
					Math.random() * 15 + 400, //x
					Math.random() * 15 + 500, //y
					Math.random() * 15 + 300 //z
				);
				
				box.rotation.set(
					Math.random() * Math.PI,
					Math.random() * Math.PI,
					Math.random() * Math.PI
				);
				
				box.castShadow = true;
				//box.addEventListener( 'collision', handleCollision );
				//box.addEventListener( 'ready', spawnBox );
				scene.add( box );
			};
			
			var  forwards_force_vector = new THREE.Vector3(5000, 0, 0);
			var backwards_force_vector = new THREE.Vector3(-5000, 0, 0);
			var player_force_vector = new THREE.Vector3(0,0,0);
			function playerControls() {
				var rotation_matrix, player_force_vector;
				
				rotation_matrix = new THREE.Matrix4();
				rotation_matrix.extractRotation(player.matrix);
				
				if ( input && player ) {
					//player turning
					var angle;
					if ( input.direction !== 0 ) {
						cameraAngleChange = input.direction * ROTATESPEED;
						//console.log("cameraVector", cameraVector, input.direction, cameraAngleChange);
						var matrix = new THREE.Matrix4().makeRotationAxis( YAXIS, cameraAngleChange );
						matrix.multiplyVector3( cameraVector );
					}
					
					player_force_vector = cameraVector.clone();

					//player movement
					var pV = player.getLinearVelocity();
					if ( input.power !== 0 ) {
						player_force_vector.multiplyScalar(input.power * MOVESPEED);
					} else {
						player_force_vector = player.getLinearVelocity().multiplyScalar(-220);//new THREE.Vector3(0, 0, 0);
						//player.setLinearVelocity(0);
					}
					player_force_vector.setY(0);
					player.applyCentralForce(player_force_vector);
					
					/*if (Math.sqrt(pV.x*pV.x + pV.z*pV.z) > player.MAXSPEED) {
						player_force_vector.divideScalar(100);
						console.log("HEYYYYYYYY");
					}*/
					
					if (input.jump === true ) {
						//console.log("PLAYER JUMP");
						player.applyCentralForce(new THREE.Vector3(0, 5e3, 0))
					} else {
						//nojump
					}
					player.__dirtyPosition = true;
					
					if ( player ) { //camera follow player
					//camera.position.copy( player.position ).addSelf( new THREE.Vector3( 40, 25, 40 ) );
					camera.position.copy( player.position ).addSelf(cameraVector.clone().multiplyScalar(-40).setY(25));
					camera.lookAt( player.position );
				}
				}
			}
			
			//controls
			input = {
				power: 0,
				direction: 0,
				jump: false,
				steering: 0
			};
			document.addEventListener('keydown', function( ev ) {
				switch ( ev.keyCode ) {
					case 37: // left
						input.direction = 1;
						break;

					case 38: // forward
						input.power = 1;
						break;

					case 39: // right
						input.direction = -1;
						break;

					case 40: // back
						input.power = -1;
						break;
						
					case 32: //space
						input.jump = true;
						break;
				}
			});
			
			document.addEventListener('keyup', function( ev ) {
				switch ( ev.keyCode ) {
					case 37: case 39: // left //right
						input.direction = 0;
						break;

					case 38: case 40: // forward
						input.power = 0;
						break;
						
					case 32: //space
						input.jump = false;
						break;
				}
			});
			
      // if body's background color is transparent, change it to white
      var rgb = $('body').css('background-color');
      rgb = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);
      if(rgb[4] === '0')
        $('body').css('background-color','#fff');
			
			// Handle window resizing
			$(window).resize(function() {
				WIDTH = window.innerWidth;
				HEIGHT = window.innerHeight;
				ASPECT = WIDTH / HEIGHT;
				if (camera) {
					camera.aspect = ASPECT;
					camera.updateProjectionMatrix();
				}
				if (renderer) {
					renderer.setSize(WIDTH, HEIGHT);
				}
				//$('#intro, #hurt').css({width: WIDTH, height: HEIGHT,});
			});
			
			// Stop moving around when the window is unfocused
			/*$(window).focus(function() {
				if (controls) controls.freeze = false;
			});
			$(window).blur(function() {
				if (controls) controls.freeze = true;
			});*/
				
      threejs_init();
			
			function threejs_animate() {
        // note: three.js includes requestAnimationFrame shim
        requestAnimationFrame(threejs_animate);
        //controls.update(clock.getDelta());
        renderer.render(scene, camera);
				scene.simulate();
				
				client_sendPosition();
      }
			
			//Multiplayer functionality ----------------------------------------------------------
			function start(){
        client_connect_to_server();
        
      }

       function client_connect_to_server() {
        
        //Store a local reference to our connection to the server
        this.socket = io.connect("http://domserver.herokuapp.com");

        //When we connect, we are not 'connected' until we have a server id
        //and are placed in a game by the server. The server sends us a message for that.
        this.socket.on('connect', function(){
            this.state = 'connecting';
        }.bind(this));

            //Sent when we are disconnected (network, server down, etc)
        //this.socket.on('disconnect', this.client_ondisconnect.bind(this));
            //Sent each tick of the server simulation. This is our authoritive update
        this.socket.on('onplayermovement', client_onplayermovement.bind(this));
            //Handle when we connect to the server, showing state and storing id's.
        this.socket.on('onconnected', client_onconnected.bind(this));
            //On error we just show that we are not connected for now. Can print the data.
        //this.socket.on('error', this.client_ondisconnect.bind(this));
            //On message from the server, we parse the commands and send it to the handlers
        //this.socket.on('message', this.client_onnetmessage.bind(this));
						//Sent when a new player connects
				this.socket.on('onnewconnection', client_onnewconnection.bind(this));
						//Sent when a player disconnects
				this.socket.on('ondisconnection', client_ondisconnection.bind(this));
      }; //client_connect_to_server

      function client_onconnected(data) {
          //The server responded that we are now in a game,
          //this lets us store the information about ourselves and set the colors
          //to show we are now ready to be playing.
          console.log("Your client id is: ", data.id);
          this.id = data.id;
          this.state = 'connected';
          this.online = true;
					
					//tell the server our position to verify the connection
					this.socket.emit('verifiedconnection', {x:player.position.x, y:player.position.y, z:player.position.z});
					//store our current position
					prevPosition = player.position.clone();
					
					$.each( data.clients, function (id, client) {
						client_addNewPlayer(id, client.x, client.y, client.z);
						console.log("Existing player: ", id, '(', client.x, client.y, client.z, ')');
					}); 
					
          //players[0] = new networkPlayer(this.id, player.position.x, player.position.y, player.position.z);
      }; //client_onconnected
			
			function client_onnewconnection(playerData) {
				client_addNewPlayer(playerData.id, playerData.x, playerData.y, playerData.z);
				console.log('player ' + playerData.id + ' has connected. Position is ' + playerData.x + ', ' + playerData.y + ',' + playerData.z);
			};
			
			var sphereGeometry = new THREE.SphereGeometry( 10, 32, 16 ); 
			var sphereMaterial = new THREE.MeshLambertMaterial( {color: 0x88ffff} ); 
			function client_addNewPlayer(id, x, y, z) {
				players[id] = new networkPlayer(id, x, y, z);
				//create a sphere
				if (x, y, z) {
						var sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
						sphere.position.set( x, y, z );
						scene.add(sphere);
						players[id].model = sphere;
					}
			};
			
			function client_ondisconnection(id) {
					scene.remove(players[id].model);
					delete players[id];
					console.log('player ' + id + ' has disconnected');
					//remove player with the given userid
			};
			
			var spheres;
      function initPlayers(){
				/*if (spheres !== undefined)
					if (spheres.length > 0)
						for (var i = 0; i < spheres.length; i++)
							scene.remove(spheres[i]);
							
        spheres=[];
        for (var i = 0; i < players.length; i++) {
          x=players[i].x;
          y=players[i].y;
          z=players[i].z;

          // Sphere parameters: radius, segments along width, segments along height
          var sphereGeometry = new THREE.SphereGeometry( 10, 32, 16 ); 
          // use a "lambert" material rather than "basic" for realistic lighting.
          //   (don't forget to add (at least one) light!)
          var sphereMaterial = new THREE.MeshLambertMaterial( {color: 0x88ffff} ); 
          sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
          sphere.position.set(x, y, z);
          scene.add(sphere);
          spheres.push(sphere); 
        };*/
      }
      function client_sendPosition(p){
			//check only when connected to server
				if (this.state === 'connected') {
					//check only once every other frame
					if (frameCount++ >= 2) {
						frameCount = 0;
						//update player position moved more than a particular threshold (expensive operation!)
						if (prevPosition.clone().subSelf(player.position).length() > 5) {
							prevPosition = player.position.clone();
							//tell the server our new position and id
							this.socket.emit('updatePosition', {id: this.id, x:player.position.x, y:player.position.y, z:player.position.z});
						}
					}
				}
			}
			
      function client_onplayermovement(data){
				players[data.id].model.position.set( data.x, data.y, data.z );
				//console.log(data.id + ' moved to ' + data.x + ', '+ data.y + ', ' + data.z);
				//initPlayers();
      };
			
      function networkPlayer(id,x,y,z){
         this.id=id;
         this.x=x;
         this.y=y;
         this.z=z;
      };
		
    }); // jquery dom ready
		
  }); // includes
})(); // bookmarklet wrapper